---
title: "4. Benchmarks of lasR vs. lidR"
author: "Jean-Romain Roussel"
output:
  html_document:
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: false
    toc_depth: 2
vignette: >
  %\VignetteIndexEntry{4. Benchmarks of lasR vs. lidR}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.height = 3, fig.width = 4)
col1 = rgb(0, 0.5, 1, alpha = 0.5)
col2 = rgb(1, 0, 0, alpha = 0.5)
col3 = rgb(0.5, 0.5, 1, alpha = 0.5)
col4 = rgb(1, 0, 1, alpha = 0.5)
```

This vignette presents benchmarks for various tasks using `lidR` and `lasR`. The x-axis represents the time spent on the task, while the y-axis represents the memory used for the task.

- **Number of files:** 4
- **Number of points:** 119 million (30 million per file)
- **Coverage:** 10.3 km² (2.5 km² per file)
- **Density:** 12 points/m²
- **OS:** Linux
- **CPU:** 
  - Intel Core i7-5600U CPU (5th generation Intel Core) 
  - Intel Core i7-1355U (13th generation Intel Core) 
- **Date:** update 2024-02-29
- **Version:** 
  - lidR 4.1.1
  - lasR 0.2.0

## Canopy Height Model


```{r, echo=FALSE}
f = c("/home/jr/Documents/Ulaval/ALS data/BCTS/092L073113_BCTS_2.laz", 
"/home/jr/Documents/Ulaval/ALS data/BCTS/092L073114_BCTS_2.laz", 
"/home/jr/Documents/Ulaval/ALS data/BCTS/092L073131_BCTS_2.laz", 
"/home/jr/Documents/Ulaval/ALS data/BCTS/092L073132_BCTS_2.laz")
```

### lidR

```r
chm = rasterize_canopy(ctg, 1, p2r())
```

### lasR

```r
pipeline = reader(ctg) + rasterize(1, "max")
processor(pipeline)
```

### Result

```{r, warning=F, echo=-1, echo=FALSE, fig.show="hold", fig.width=4}
#1

f = system.file("extdata/benchmarks", "lasR_test_1_jr-ThinkPad-T450s.data", package = "lasR")
m_lasr = read.table(f)$V1
t_lasr = (1:length(m_lasr)-1)*2/60

f = system.file("extdata/benchmarks", "lidR_test_1_jr-ThinkPad-T450s.data", package = "lasR")
m_lidr =  read.table(f)$V1
t_lidr = (1:length(m_lidr)-1)*2/60

f = system.file("extdata/benchmarks", "lidR_test_1_FFGG-1009803.data", package = "lasR")
m_lidr2 = read.table(f)$V1
t_lidr2 = (1:length(m_lidr2)-1)*2/60

f = system.file("extdata/benchmarks", "lasR_test_1_FFGG-1009803.data", package = "lasR")
m_lasr2 = read.table(f)$V1
t_lasr2 = (1:length(m_lasr2)-1)*2/60

tmax = max(t_lidr, t_lasr, t_lidr2, t_lasr2)
mmax = max(m_lidr, m_lasr, m_lidr2, m_lasr2)/1000

# Thinkpad

x = t_lidr
y = m_lidr/1000

par(mar = c(4,4,1,1), cex = 0.8)

plot(x, y, type = "n", xlim = c(0, tmax), ylim = c(0, mmax), ylab = "Memory (GB)", xlab = "Time (min)", main = "Intel Core i7-5600U")

polygon(c(x, rev(x)), c(rep(0, length(x)), rev(y)), col = col1, border = NA)
lines(x, y, col = "blue", lwd = 2)

x = t_lasr
y = m_lasr/1000

polygon(c(x, rev(x)), c(rep(0, length(x)), rev(y)), col = col2 , border = NA)
lines(x, y, col = "red", lwd = 2)

legend("topleft", legend = c("lidR 4.1.1", "lasR 0.2.0"), fill = c(col1, col2), border = NA)

# Latitude

x = t_lidr2
y = m_lidr2/1000

plot(x, y, type = "n", xlim = c(0, tmax), ylim = c(0, mmax), ylab = "Memory (GB)", xlab = "Time (min)", main = "Intel Core i7-1355U")

polygon(c(x, rev(x)), c(rep(0, length(x)), rev(y)), col = col1 , border = NA)
lines(x, y, col = "blue", lwd = 2)

x = t_lasr2
y = m_lasr2/1000

polygon(c(x, rev(x)), c(rep(0, length(x)), rev(y)), col = col2 , border = NA)
lines(x, y, col = "red", lwd = 2)


legend("topleft", legend = c("lidR 4.1.1", "lasR 0.2.0"), fill = c(col1, col2), border = NA)
```

## Digital Terrain Model

```{r, echo=FALSE}
f = c("/home/jr/Documents/Ulaval/ALS data/BCTS/092L073113_BCTS_2.laz", 
"/home/jr/Documents/Ulaval/ALS data/BCTS/092L073114_BCTS_2.laz", 
"/home/jr/Documents/Ulaval/ALS data/BCTS/092L073131_BCTS_2.laz", 
"/home/jr/Documents/Ulaval/ALS data/BCTS/092L073132_BCTS_2.laz")
```

### lidR

```r
dtm = rasterize_terrain(ctg, 1, tin())
```

### lasR

```r
tri = triangulate(filter = keep_ground())
pipeline = reader(ctg, filter = keep_ground()) + tri + rasterize(1, tri)
processor(pipeline)
```

### Result

```{r, warning=F, echo=-1, echo=FALSE, fig.show="hold", fig.width=4}
# 2
f = system.file("extdata/benchmarks", "lasR_test_2_jr-ThinkPad-T450s.data", package = "lasR")
m_lasr = read.table(f)$V1
t_lasr = (1:length(m_lasr)-1)*2/60

f = system.file("extdata/benchmarks", "lidR_test_2_jr-ThinkPad-T450s.data", package = "lasR")
m_lidr = read.table(f)$V1
t_lidr = (1:length(m_lidr)-1)*2/60

f = system.file("extdata/benchmarks", "lidR_test_2_FFGG-1009803.data", package = "lasR")
m_lidr2 = read.table(f)$V1
t_lidr2 = (1:length(m_lidr2)-1)*2/60

f = system.file("extdata/benchmarks", "lasR_test_2_FFGG-1009803.data", package = "lasR")
m_lasr2 = read.table(f)$V1
t_lasr2 = (1:length(m_lasr2)-1)*2/60

tmax = max(t_lidr, t_lasr, t_lidr2, t_lasr2)
mmax = max(m_lidr, m_lasr, m_lidr2, m_lasr2)/1000

# Thinkpad

x = t_lidr
y = m_lidr/1000

par(mar = c(4,4,1,1), cex = 0.8)

plot(x, y, type = "n", xlim = c(0, tmax), ylim = c(0, mmax), ylab = "Memory (GB)", xlab = "Time (min)", main = "Intel Core i7-5600U")

polygon(c(x, rev(x)), c(rep(0, length(x)), rev(y)), col = col1, border = NA)
lines(x, y, col = "blue", lwd = 2)

x = t_lasr
y = m_lasr/1000

polygon(c(x, rev(x)), c(rep(0, length(x)), rev(y)), col = col2 , border = NA)
lines(x, y, col = "red", lwd = 2)

legend("topright", legend = c("lidR 4.1.1", "lasR 0.2.0"), fill = c(col1, col2), border = NA)

# Latitude

x = t_lidr2
y = m_lidr2/1000

plot(x, y, type = "n", xlim = c(0, tmax), ylim = c(0, mmax), ylab = "Memory (GB)", xlab = "Time (min)", main = "Intel Core i7-1355U")

polygon(c(x, rev(x)), c(rep(0, length(x)), rev(y)), col = col1 , border = NA)
lines(x, y, col = "blue", lwd = 2)

x = t_lasr2
y = m_lasr2/1000

polygon(c(x, rev(x)), c(rep(0, length(x)), rev(y)), col = col2 , border = NA)
lines(x, y, col = "red", lwd = 2)


legend("topright", legend = c("lidR 4.1.1", "lasR 0.2.0"), fill = c(col1, col2), border = NA)
```

## Multiple raster

The gain in terms of computation time is much more significant when running multiple stages in a single pipeline because files are read only once in `lasR` but multiple times in `lidR`. Here, all operations are executed in a single pass at the C++ level, resulting in more efficient memory management.

### lidR

```r
custom_function = function(z,i) { list(avgz = mean(z), avgi = mean(i)) }
ctg = readLAScatalog(f)
chm = rasterize_canopy(ctg, 1, p2r())
met = pixel_metrics(ctg, ~custom_function(Z, Intensity), 20)
den = rasterize_density(ctg, 5)
```

### lasR

```r
custom_function = function(z,i) { list(avgz = mean(z), avgi = mean(i)) }
read = reader(folder)
chm = rasterize(1, "max")
met = rasterize(20, custom_function(Z, Intensity))
den = rasterize(5, "count")
pipeline = read + chm + met + den
processor(pipeline)
```



```{r, warning=F, echo=-1, echo=FALSE, fig.show="hold", fig.width=4}
# 3
f = system.file("extdata/benchmarks", "lasR_test_3_jr-ThinkPad-T450s.data", package = "lasR")
m_lasr = read.table(f)$V1
t_lasr = 1:length(m_lasr)*2/60

f = system.file("extdata/benchmarks", "lidR_test_3_jr-ThinkPad-T450s.data", package = "lasR")
m_lidr = read.table(f)$V1
t_lidr = 1:length(m_lidr)*2/60

f = system.file("extdata/benchmarks", "lidR_test_3_FFGG-1009803.data", package = "lasR")
m_lidr2 = read.table(f)$V1
t_lidr2 = 1:length(m_lidr2)*2/60

f = system.file("extdata/benchmarks", "lasR_test_3_FFGG-1009803.data", package = "lasR")
m_lasr2 = read.table(f)$V1
t_lasr2 = 1:length(m_lasr2)*2/60

tmax = max(t_lidr, t_lasr, t_lidr2, t_lasr2)
mmax = max(m_lidr, m_lasr, m_lidr2, m_lasr2)/1000

x = t_lidr
y = m_lidr/1000

par(mar = c(4,4,1,1), cex = 0.8)

plot(x, y, type = "n", xlim = c(0, tmax), ylim = c(0, mmax), ylab = "Memory (GB)", xlab = "Time (min)", main = "Intel Core i7-5600U CPU")

polygon(c(x, rev(x)), c(rep(0, length(x)), rev(y)), col = col1, border = NA)
lines(x, y, col = "blue", lwd = 2)

x = t_lasr
y = m_lasr/1000

polygon(c(x, rev(x)), c(rep(0, length(x)), rev(y)), col = col2 , border = NA)
lines(x, y, col = "red", lwd = 2)

legend("topright", legend = c("lidR 4.1.1", "lasR 0.2.0"), fill = c(col1, col2), border = NA)

# Latitude

x = t_lidr2
y = m_lidr2/1000

plot(x, y, type = "n",  xlim = c(0, tmax), ylim = c(0, mmax), ylab = "Memory (GB)", xlab = "Time (min)", main = "Intel Core i7-1355U")

polygon(c(x, rev(x)), c(rep(0, length(x)), rev(y)), col = col1, border = NA)
lines(x, y, col = "blue", lwd = 2)

x = t_lasr2
y = m_lasr2/1000

polygon(c(x, rev(x)), c(rep(0, length(x)), rev(y)), col = col2 , border = NA)
lines(x, y, col = "red", lwd = 2)

legend("topright", legend = c("lidR 4.1.1", "lasR 0.2.0"), fill = c(col1, col2), border = NA)
```


## Complex Pipeline

In this complex pipeline, the point cloud is normalized and written to new files. A Digital Terrain Model (DTM) is produced, a Canopy Height Model (CHM) is built, and individual trees are detected. These detected trees are then used as seeds for a region-growing algorithm that segments the trees. The `lasR` pipeline can handle hundreds of laser tiles, while `lidR` may struggle to apply the same pipeline, especially during tree segmentation.


```r
read = reader(ctg)
del = triangulate(filter = keep_ground())
norm = transform_with(del)
dtm = rasterize(1, del)
chm = rasterize(1, "max")
seed = local_maximum(3)
tree = region_growing(chm, seed)
write = write_las()
pipeline = read + del + norm + write + dtm + chm +  seed + tree
ans = processor(pipeline, progress = TRUE)
```

```{r, warning=F, echo=-1, echo=FALSE, fig.show="hold", fig.width=4}
f = system.file("extdata/benchmarks", "lasR_test_4_FFGG-1009803.data", package = "lasR")
m_lasr = read.table(f)$V1

f = system.file("extdata/benchmarks", "lidR_test_4_FFGG-1009803.data", package = "lasR")
m_lidr = read.table(f)$V1

t_lasr = (1:length(m_lasr)-1)*2/60
t_lidr = (1:length(m_lidr)-1)*2/60

col1 = rgb(0, 0.5, 1, alpha = 0.5)
col2 = rgb(1, 0, 0, alpha = 0.5)

x = t_lidr
y = m_lidr/1000

par(mar = c(4,4,1,1), cex = 0.8)

plot(x, y, type = "n", ylim = c(0, max(y)), ylab = "Memory (GB)", xlab = "Time (min)", main = "Intel Core i7-1355U")

polygon(c(x, rev(x)), c(rep(0, length(x)), rev(y)), col = col1, border = NA)
lines(x, y, col = "blue", lwd = 2)

x = t_lasr
y = m_lasr/1000

polygon(c(x, rev(x)), c(rep(0, length(x)), rev(y)), col = col2 , border = NA)
lines(x, y, col = "red", lwd = 2)

legend("topright", legend = c("lidR 4.1.1", "lasR 0.2.0"), fill = c(col1, col2), border = NA)
```