<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Parallel processing â€¢ lasR</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Parallel processing">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">lasR</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.10.3</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Presentation</h6></li>
    <li><a class="dropdown-item" href="../articles/why.html">Why lasR?</a></li>
    <li><a class="dropdown-item" href="../articles/benchmarks.html">Benchmarks of lasR vs. lidR</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Tutorials</h6></li>
    <li><a class="dropdown-item" href="../articles/tutorial.html">Tutorial</a></li>
    <li><a class="dropdown-item" href="../articles/multithreading.html">Parallel processing</a></li>
    <li><a class="dropdown-item" href="../articles/r-stages.html">R stages</a></li>
    <li><a class="dropdown-item" href="../articles/baba.html">Buffered Area Based Approach</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/r-lidar/lasR/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Parallel processing</h1>
                        <h4 data-toc-skip class="author">Jean-Romain
Roussel</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/r-lidar/lasR/blob/main/vignettes/multithreading.Rmd" class="external-link"><code>vignettes/multithreading.Rmd</code></a></small>
      <div class="d-none name"><code>multithreading.Rmd</code></div>
    </div>

    
    
<p>The multi-threading in <code>lasR</code> is pretty similar to
<code>lidR</code>, except it does not use the package
<code>future</code>. Everything is natively coded in C++ with
<code>OpenMP</code>. There are 4 different parallelization strategies
that can be assigned for a given task with
<code>exec(pipeline, ncores = strategy_name(n))</code> or that can be
assigned globally for the entiere session with
<code>set_parallel_strategy(strategy_name(n))</code>.</p>
<blockquote style="background-color: #f8d7da; border-left: 5px solid #dc3545; padding: 10px; font-size: 14px; border-radius: 5px;">
<code>lasR</code> uses <code>OpenMP</code> which means that the package
supports parallelism on Linux and Windows but not on macOS where Apple
has explicitly disabled <code>OpenMP</code> support in compilers that
they ship in <code>Xcode</code>. Interested readers can read the
following links: <a href="https://mac.r-project.org/openmp/" class="external-link">OpenMP on
macOS</a>; <a href="https://www.btskinner.io/code/install-r-with-openblas-and-openmp-on-macos-mojave/" class="external-link">OpenBLAS
and OpenMP on macOS</a> ; <a href="https://github.com/Rdatatable/data.table/wiki/Installation#Enable-openmp-for-macos" class="external-link">Enable
OpenMP for macOS</a>
</blockquote>
<div class="section level2">
<h2 id="sequential-strategy">Sequential strategy<a class="anchor" aria-label="anchor" href="#sequential-strategy"></a>
</h2>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/multithreading.html">set_parallel_strategy</a></span><span class="op">(</span><span class="fu"><a href="../reference/multithreading.html">sequential</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># or</span></span>
<span><span class="fu"><a href="../reference/exec.html">exec</a></span><span class="op">(</span><span class="va">pipeline</span>, on <span class="op">=</span> <span class="va">f</span>, ncores <span class="op">=</span> <span class="fu"><a href="../reference/multithreading.html">sequential</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>The sequential strategy is <strong>not</strong> the default strategy.
However, it is easier to start with this option to explain some
specificities of <code>lasR</code>. In sequential processing, as the
name indicates, the LAS/LAZ files are processed sequentially, and
nothing is parallelized. The point cloud from one file passes through
the pipeline while the other files are waiting to be processed. This is
represented in the figure below.</p>
<p><img src="sequential.png" width="600"></p>
</div>
<div class="section level2">
<h2 id="concurrent-points-strategy">Concurrent points strategy<a class="anchor" aria-label="anchor" href="#concurrent-points-strategy"></a>
</h2>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/multithreading.html">set_parallel_strategy</a></span><span class="op">(</span><span class="fu"><a href="../reference/multithreading.html">concurrent_points</a></span><span class="op">(</span><span class="fl">4</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># or</span></span>
<span><span class="fu"><a href="../reference/exec.html">exec</a></span><span class="op">(</span><span class="va">pipeline</span>, on <span class="op">=</span> <span class="va">f</span>, ncores <span class="op">=</span> <span class="fu"><a href="../reference/multithreading.html">concurrent_points</a></span><span class="op">(</span><span class="fl">4</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Concurrent points with <code><a href="../reference/multithreading.html">half_cores()</a></code> is the default
strategy. The LAS/LAZ files are processed sequentially. The point cloud
from one file passes through the pipeline while the other files are
waiting. Inside the pipeline, some stages are parallelized and are
processing the points in different threads. Each core processes a subset
of the point cloud. The stages that are parallelized are consequently
faster, but in practice, not a lot of stages can easily be parallelized
this way.</p>
<p><img src="concurent_points.png" width="600"></p>
</div>
<div class="section level2">
<h2 id="concurrent-files-strategy">Concurrent files strategy<a class="anchor" aria-label="anchor" href="#concurrent-files-strategy"></a>
</h2>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/multithreading.html">set_parallel_strategy</a></span><span class="op">(</span><span class="fu"><a href="../reference/multithreading.html">concurrent_files</a></span><span class="op">(</span><span class="fl">4</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># or</span></span>
<span><span class="fu"><a href="../reference/exec.html">exec</a></span><span class="op">(</span><span class="va">pipeline</span>, on <span class="op">=</span> <span class="va">f</span>, ncores <span class="op">=</span> <span class="fu"><a href="../reference/multithreading.html">concurrent_files</a></span><span class="op">(</span><span class="fl">4</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># or</span></span>
<span><span class="fu"><a href="../reference/exec.html">exec</a></span><span class="op">(</span><span class="va">pipeline</span>, on <span class="op">=</span> <span class="va">f</span>, ncores <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> <span class="co"># more convenient</span></span></code></pre></div>
<p>The LAS/LAZ files are processed in parallel. The point cloud from
several files passes through several cloned pipelines while the other
files are waiting. Inside the pipeline, the stages are not parallelized.
This puts a lot of pressure on the disk because many LAS/LAZ files are
read simultaneously, but also each stage can write some
raster/vector/LAS files simultaneously. Additionally, it uses a lot of
memory since many LAS files are loaded in memory simultaneously. With
modern and fast SSD disks and a significant amount of RAM, this is the
fastest option. Of course, users <strong>should not</strong> use all
their cores; otherwise, they may run out of memory. See also the <a href="benchmarks.html">benchmarks</a> vignette.</p>
<p><img src="concurent_files.png" width="600"></p>
</div>
<div class="section level2">
<h2 id="nested-strategy">Nested strategy<a class="anchor" aria-label="anchor" href="#nested-strategy"></a>
</h2>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/multithreading.html">set_parallel_strategy</a></span><span class="op">(</span><span class="fu"><a href="../reference/multithreading.html">nested</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># or</span></span>
<span><span class="fu"><a href="../reference/exec.html">exec</a></span><span class="op">(</span><span class="va">pipeline</span>, on <span class="op">=</span> <span class="va">f</span>, ncores <span class="op">=</span> <span class="fu"><a href="../reference/multithreading.html">nested</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>The LAS/LAZ files are processed in parallel. The point cloud from
several files passes through several cloned pipelines while the other
files are waiting. Inside the pipeline, some stages are also
parallelized and are processing the points in different threads. Nested
is reserved for experts only.</p>
<p><img src="nested.png" width="600"></p>
</div>
<div class="section level2">
<h2 id="special-cases">Special cases<a class="anchor" aria-label="anchor" href="#special-cases"></a>
</h2>
<p>In <code>lasR</code>, everything is written in pure C++ except for
two stages that inject user-defined R code and use the R C API (see <a href="r-stages.html">R stages</a>)</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/rasterize.html">rasterize</a></span><span class="op">(</span><span class="fl">20</span>, <span class="fu">user_function</span><span class="op">(</span><span class="va">Z</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/callback.html">callback</a></span><span class="op">(</span><span class="fu">user_function</span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>R is <strong>NOT</strong> multi-threaded, and thus calling these
stages in parallel is not thread-safe and will crash the R session in
the best case or deeply corrupt the R memory in the worst case.
Consequently, these stages are protected and pipelines involving these
stages cannot be ran in parallel with the <code>concurrent-files</code>
strategy.</p>
</div>
<div class="section level2">
<h2 id="real-timeline">Real timeline<a class="anchor" aria-label="anchor" href="#real-timeline"></a>
</h2>
<p>In the figures above, the pipelines are represented in an idealized
and simplified manner. For example, all stages are depicted as taking
the same amount of time, and all the cores are shown running in parallel
without any overhead. While this simplification aids understanding, it
does not capture the full complexity of the actual process. The actual
timeline of a real pipeline processing of 9 files is shown in the figure
below.</p>
<p><img src="timeline.png"></p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Jean-Romain Roussel.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
