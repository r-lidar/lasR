<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>R stages • lasR</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="R stages">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">lasR</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.17.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Presentation</h6></li>
    <li><a class="dropdown-item" href="../articles/why.html">Why lasR?</a></li>
    <li><a class="dropdown-item" href="../articles/benchmarks.html">Benchmarks of lasR vs. lidR</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Tutorials</h6></li>
    <li><a class="dropdown-item" href="../articles/tutorial.html">Tutorial</a></li>
    <li><a class="dropdown-item" href="../articles/multithreading.html">Parallel processing</a></li>
    <li><a class="dropdown-item" href="../articles/r-stages.html">R stages</a></li>
    <li><a class="dropdown-item" href="../articles/baba.html">Buffered Area Based Approach</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/r-lidar/lasR/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>R stages</h1>
                        <h4 data-toc-skip class="author">Jean-Romain
Roussel</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/r-lidar/lasR/blob/main/vignettes/r-stages.Rmd" class="external-link"><code>vignettes/r-stages.Rmd</code></a></small>
      <div class="d-none name"><code>r-stages.Rmd</code></div>
    </div>

    
    
<p><code>lasR</code> is a standalone software that can work
independently outside of R. The R part of <code>lasR</code> is only an
API to conveniently build pipelines, but this task could be performed by
another software such as a Python package, a QGIS plugin, or dedicated
software. Currently, the only existing API is the <code>lasR</code>
package.</p>
<p>However, the R package version offers additional stages that allow
injecting R code into the pipeline. These stages cannot exist in
standalone software independent of R.</p>
<div class="section level2">
<h2 id="rasterize">Rasterize<a class="anchor" aria-label="anchor" href="#rasterize"></a>
</h2>
<p>In the <a href="tutorial.html">tutorial</a>, we mentioned that
<code><a href="../reference/rasterize.html">rasterize()</a></code> supports the injection of a user-defined R
expression. This is equivalent to <code>pixel_metrics()</code> from the
package <code>lidR</code>. Any user-defined function can be mapped,
making it extremely versatile but slower.</p>
<p>Let’s compute the map of the median intensity by injecting a
user-defined expression. Like in <code>lidR</code>, the attributes of
the point cloud are named: <code>X</code>, <code>Y</code>,
<code>Z</code>, <code>Intensity</code>, <code>gpstime</code>,
<code>ReturnNumber</code>, <code>NumberOfreturns</code>,
<code>Classification</code>, <code>UserData</code>,
<code>PointSourceID</code>, <code>R</code>, <code>G</code>,
<code>B</code>, <code>NIR</code>. For users familiar with the
<code>lidR</code> package, note that there is no
<code>ScanAngleRank/ScanAngle</code>; instead the scanner angle is
always named <code>ScanAngle</code> and is numeric. Also flags are named
<code>Withheld</code>, <code>Synthetic</code> and
<code>Keypoint</code>.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pipeline</span> <span class="op">=</span> <span class="fu"><a href="../reference/rasterize.html">rasterize</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="va">Intensity</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">ans</span> <span class="op">=</span> <span class="fu"><a href="../reference/exec.html">exec</a></span><span class="op">(</span><span class="va">pipeline</span>, on <span class="op">=</span> <span class="va">f</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">ans</span>, mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">3</span><span class="op">)</span>, col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/palettes.html" class="external-link">heat.colors</a></span><span class="op">(</span><span class="fl">15</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="r-stages_files/figure-html/rasterize3-1.png" width="700"></p>
<blockquote style="background-color: #d6e9f9; border-left: 5px solid #428bca; padding: 10px; font-size: 14px; border-radius: 5px;">
Notice that, in this specific case, using
<code>rasterize(10, "i_median")</code> is more efficient.
</blockquote>
</div>
<div class="section level2">
<h2 id="callback">Callback<a class="anchor" aria-label="anchor" href="#callback"></a>
</h2>
<p>The <code>callback</code> stage holds significant importance as the
second and last entry point to inject R code into the pipeline,
following <code><a href="../reference/rasterize.html">rasterize()</a></code>. For those familiar with the
<code>lidR</code> package, the initial step often involves reading data
with <code>lidR::readLAS()</code> to expose the point cloud as a
<code>data.frame</code> object in R. In contrast, <code>lasR</code>
loads the point cloud optimally in C++ without exposing it directly to
R. However, with <code>callback</code>, it becomes possible to expose
the point cloud as a <code>data.frame</code> for executing specific R
functions.</p>
<p>Similar to <code>lidR</code>, the attributes of the point cloud in
<code>lasR</code> are named: <code>X</code>, <code>Y</code>,
<code>Z</code>, <code>Intensity</code>, <code>gpstime</code>,
<code>ReturnNumber</code>, <code>NumberOfreturns</code>,
<code>Classification</code>, <code>UserData</code>,
<code>PointSourceID</code>, <code>R</code>, <code>G</code>,
<code>B</code>, <code>NIR</code>. Notably, for users accustomed to the
<code>lidR</code> package, the scanner angle is consistently named
<code>ScanAngle</code> and is numeric, as opposed to
<code>ScanAngleRank/ScanAngle</code>. Additionally, flags are named
<code>Withheld</code>, <code>Synthetic</code>, and
<code>Keypoint</code>.</p>
<p>Let’s delve into a simple example. For each LAS file, the
<code>callback</code> loads the point cloud as a <code>data.frame</code>
and invokes the <code>meanz()</code> function on the
<code>data.frame</code>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">meanz</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">{</span> <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">Z</span><span class="op">)</span><span class="op">)</span> <span class="op">}</span></span>
<span><span class="va">call</span> <span class="op">=</span> <span class="fu"><a href="../reference/callback.html">callback</a></span><span class="op">(</span><span class="va">meanz</span>, expose <span class="op">=</span> <span class="st">"xyz"</span><span class="op">)</span></span>
<span><span class="va">ans</span> <span class="op">=</span> <span class="fu"><a href="../reference/exec.html">exec</a></span><span class="op">(</span><span class="va">call</span>, on <span class="op">=</span> <span class="va">f</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">ans</span><span class="op">)</span></span>
<span><span class="co">#&gt;  - 809.0835 </span></span>
<span><span class="co">#&gt;  - 13.27202</span></span></code></pre></div>
<p>Here the output is a <code>list</code> with two elements because we
processed two files (<code>f</code> is not displayed in this document).
The average Z elevation are respectively 809.08 and 13.27 in each
file.</p>
<blockquote style="background-color: #fff3cd; border-left: 5px solid #ffc107; padding: 10px; font-size: 14px; border-radius: 5px;">
Be mindful that, for a given LAS/LAZ file, the point cloud may contain
more points than the original file <strong>if the file is loaded with a
buffer</strong>. Further clarification on this matter will be provided
later.
</blockquote>
<p>The <code>callback</code> function is versatile and can also be
employed to edit the point cloud. When the user-defined function returns
a <code>data.frame</code> with the same number of rows as the original
one, the function edits the underlying C++ dataset. This enables users
to perform tasks such as assigning a class to a specific point. While
physically removing points is not possible, users can flag points as
<code>Withheld</code>. In such cases, these points will not be processed
in subsequent stages, they are discarded.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">edit_points</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span><span class="op">)</span></span>
<span><span class="op">{</span></span>
<span>  <span class="va">data</span><span class="op">$</span><span class="va">Classification</span><span class="op">[</span><span class="fl">5</span><span class="op">:</span><span class="fl">7</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2L</span>,<span class="fl">2L</span>,<span class="fl">2L</span><span class="op">)</span></span>
<span>  <span class="va">data</span><span class="op">$</span><span class="va">Withheld</span> <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="va">data</span><span class="op">$</span><span class="va">Withheld</span><span class="op">[</span><span class="fl">12</span><span class="op">]</span> <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">call</span> <span class="op">=</span> <span class="fu"><a href="../reference/callback.html">callback</a></span><span class="op">(</span><span class="va">edit_points</span>, expose <span class="op">=</span> <span class="st">"xyzc"</span><span class="op">)</span></span>
<span><span class="va">ans</span> <span class="op">=</span> <span class="fu"><a href="../reference/exec.html">exec</a></span><span class="op">(</span><span class="va">call</span>, on <span class="op">=</span> <span class="va">f</span><span class="op">)</span></span>
<span><span class="va">ans</span></span>
<span><span class="co">#&gt; NULL</span></span></code></pre></div>
<p>As observed, here, this time <code>callback</code> does not
explicitly return anything; however, it edited the point cloud
internally. To generate an output, users must use another stage such as
<code><a href="../reference/write.html">write_las()</a></code>. It’s important to note that
<code><a href="../reference/write.html">write_las()</a></code> will <strong>NOT</strong> write the point
number 12 which is flagged <code>withheld</code>. Neither any subsequent
stage will process it. The point is still in memory but is
discarded.</p>
<blockquote style="background-color: #f8d7da; border-left: 5px solid #dc3545; padding: 10px; font-size: 14px; border-radius: 5px;">
For memory and efficiency reasons, it is not possible to physically
remove a point from the underlying memory in <code>lasR</code>. Instead,
the points flagged as <code>withheld</code> will <strong>never be
processed</strong>. One consequence of this, is that points flagged as
withheld in a LAS/LAZ file <strong>will not</strong> be processed in
<code>lasR</code>. This aligns with the intended purpose of the flag
according to the LAS specification but may differ from the default
behavior of many software on the market including <code>lidR</code>.
</blockquote>
<p>Now, let’s explore the capabilities of <code>callback</code> further.
First, let’s create a lidR-like <code>read_las()</code> function to
expose the point cloud to R. In the following example, the user-defined
function is employed to return the <code>data.frame</code> as is. When
the user’s function returns a <code>data.frame</code> with the same
number of points as the original dataset, this updates the points at the
C++ level. Here, we use <code>no_las_update = TRUE</code> to explicitly
return the result.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">read_las</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">f</span>, <span class="va">select</span> <span class="op">=</span> <span class="st">"xyzi"</span>, <span class="va">filter</span> <span class="op">=</span> <span class="st">""</span><span class="op">)</span></span>
<span><span class="op">{</span></span>
<span>  <span class="va">load</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">{</span> <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">}</span></span>
<span>  <span class="va">read</span> <span class="op">=</span> <span class="fu"><a href="../reference/reader.html">reader</a></span><span class="op">(</span>filter <span class="op">=</span> <span class="va">filter</span><span class="op">)</span></span>
<span>  <span class="va">call</span> <span class="op">=</span> <span class="fu"><a href="../reference/callback.html">callback</a></span><span class="op">(</span><span class="va">load</span>, expose <span class="op">=</span> <span class="va">select</span>, no_las_update <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span> <span class="op">(</span><span class="fu"><a href="../reference/exec.html">exec</a></span><span class="op">(</span><span class="va">read</span><span class="op">+</span><span class="va">call</span>, on <span class="op">=</span> <span class="va">f</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">f</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"Topography.las"</span>, package<span class="op">=</span><span class="st">"lasR"</span><span class="op">)</span></span>
<span><span class="va">las</span> <span class="op">=</span> <span class="fu">read_las</span><span class="op">(</span><span class="va">f</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">las</span><span class="op">)</span></span>
<span><span class="co">#&gt;          X       Y        Z Intensity</span></span>
<span><span class="co">#&gt; 1 273357.1 5274360 806.5340      1340</span></span>
<span><span class="co">#&gt; 2 273357.2 5274359 806.5635       728</span></span>
<span><span class="co">#&gt; 3 273357.2 5274358 806.0248      1369</span></span>
<span><span class="co">#&gt; 4 273357.2 5274510 809.6303       589</span></span>
<span><span class="co">#&gt; 5 273357.2 5274509 809.3880      1302</span></span>
<span><span class="co">#&gt; 6 273357.2 5274508 809.4847       123</span></span></code></pre></div>
<p>Ground points can also be classified using an R function, such as the
one provided by the <code>RCSF</code> package:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">csf</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span><span class="op">)</span></span>
<span><span class="op">{</span></span>
<span>  <span class="va">id</span> <span class="op">=</span> <span class="fu">RCSF</span><span class="fu">::</span><span class="fu">CSF</span><span class="op">(</span><span class="va">data</span><span class="op">)</span></span>
<span>  <span class="va">class</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">integer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">class</span><span class="op">[</span><span class="va">id</span><span class="op">]</span> <span class="op">=</span> <span class="fl">2L</span></span>
<span>  <span class="va">data</span><span class="op">$</span><span class="va">Classification</span> <span class="op">&lt;-</span> <span class="va">class</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">read</span> <span class="op">=</span> <span class="fu"><a href="../reference/reader.html">reader</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">classify</span> <span class="op">=</span> <span class="fu"><a href="../reference/callback.html">callback</a></span><span class="op">(</span><span class="va">csf</span>, expose <span class="op">=</span> <span class="st">"xyz"</span><span class="op">)</span></span>
<span><span class="va">write</span> <span class="op">=</span> <span class="fu"><a href="../reference/write.html">write_las</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">pipeline</span> <span class="op">=</span> <span class="va">read</span> <span class="op">+</span> <span class="va">classify</span> <span class="op">+</span> <span class="va">write</span></span>
<span><span class="fu"><a href="../reference/exec.html">exec</a></span><span class="op">(</span><span class="va">pipeline</span>, on <span class="op">=</span> <span class="va">f</span><span class="op">)</span></span></code></pre></div>
<blockquote style="background-color: #fff3cd; border-left: 5px solid #ffc107; padding: 10px; font-size: 14px; border-radius: 5px;">
<code><a href="../reference/callback.html">callback()</a></code> exposes the point cloud as a
<code>data.frame</code>. This is the only way to expose the point clouds
to users in a manageable way. One of the reasons why <code>lasR</code>
is more memory-efficient and faster than <code>lidR</code> is that it
<strong>does not</strong> expose the point cloud as a
<code>data.frame</code>. Thus, the pipelines using
<code><a href="../reference/callback.html">callback()</a></code> are not significantly different from
<code>lidR</code>. The advantage of using <code>lasR</code> here is the
ability to pipe different stages.
</blockquote>
</div>
<div class="section level2">
<h2 id="buffer">Buffer<a class="anchor" aria-label="anchor" href="#buffer"></a>
</h2>
<p>Point clouds are typically stored in multiple contiguous files. To
avoid edge artifacts, each file must be loaded with extra points coming
from neighboring files. Everything is handled automatically, except for
the <code><a href="../reference/callback.html">callback()</a></code> stage. In <code><a href="../reference/callback.html">callback()</a></code>, the point
cloud is exposed as a <code>data.frame</code> with the buffer, providing
the user-defined function with some spatial context. If
<code>callback</code> is used to edit the points, everything is handled
internally. However, if an R object is returned, it is the
responsibility of the user to handle the buffer.</p>
<p>For example, in the following pipeline, we are processing two files,
and <code><a href="../reference/callback.html">callback()</a></code> is used to count the number of points. The
presence of <code><a href="../reference/triangulate.html">triangulate()</a></code> implies that each file will be
loaded with a buffer to make a valid triangulation. Consequently,
counting the points in <code><a href="../reference/callback.html">callback()</a></code> returns more points than
<code><a href="../reference/summarise.html">summarise()</a></code> because <code><a href="../reference/summarise.html">summarise()</a></code> is an internal
function that knows how to deal with the buffer.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">count</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">{</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">X</span><span class="op">)</span> <span class="op">}</span></span>
<span><span class="va">del</span> <span class="op">=</span> <span class="fu"><a href="../reference/triangulate.html">triangulate</a></span><span class="op">(</span>filter <span class="op">=</span> <span class="fu"><a href="../reference/filters.html">keep_ground</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">npts</span> <span class="op">=</span> <span class="fu"><a href="../reference/callback.html">callback</a></span><span class="op">(</span><span class="va">count</span>, expose <span class="op">=</span> <span class="st">"x"</span><span class="op">)</span></span>
<span><span class="va">sum</span> <span class="op">=</span> <span class="fu"><a href="../reference/summarise.html">summarise</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">ans</span> <span class="op">=</span> <span class="fu"><a href="../reference/exec.html">exec</a></span><span class="op">(</span><span class="va">del</span> <span class="op">+</span> <span class="va">npts</span> <span class="op">+</span> <span class="va">sum</span>, on <span class="op">=</span> <span class="va">f</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">ans</span><span class="op">$</span><span class="va">callback</span><span class="op">)</span></span>
<span><span class="co">#&gt;  - 585020 </span></span>
<span><span class="co">#&gt;  - 868951</span></span>
<span><span class="va">ans</span><span class="op">$</span><span class="va">callback</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">+</span> <span class="va">ans</span><span class="op">$</span><span class="va">callback</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="co">#&gt; [1] 1453971</span></span>
<span><span class="va">ans</span><span class="op">$</span><span class="va">summary</span><span class="op">$</span><span class="va">npoints</span></span>
<span><span class="co">#&gt; [1] 1355607</span></span></code></pre></div>
<p>We can compare this with the pipeline without
<code><a href="../reference/triangulate.html">triangulate()</a></code>. In this case, there is no reason to use a
buffer, and the files are not buffered. The counts are equal.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ans</span> <span class="op">=</span> <span class="fu"><a href="../reference/exec.html">exec</a></span><span class="op">(</span><span class="va">npts</span> <span class="op">+</span> <span class="va">sum</span>, on <span class="op">=</span> <span class="va">f</span><span class="op">)</span></span>
<span><span class="va">ans</span><span class="op">$</span><span class="va">callback</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">+</span> <span class="va">ans</span><span class="op">$</span><span class="va">callback</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="co">#&gt; [1] 1355607</span></span>
<span><span class="va">ans</span><span class="op">$</span><span class="va">summary</span><span class="op">$</span><span class="va">npoints</span></span>
<span><span class="co">#&gt; [1] 1355607</span></span></code></pre></div>
<p>To handle the buffer, the user can read the attribute
<code>bbox</code> of the <code>data.frame</code>. It contains the
bounding box of the point cloud without the buffer or use the column
<code>Buffer</code> that contains <code>TRUE</code> or
<code>FALSE</code> for each point. If <code>TRUE</code>, the point is in
the buffer. The buffer is exposed only if the user includes the letter
<code>'b'</code>.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">count_buffer_aware</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">bbox</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">data</span>, <span class="st">"bbox"</span><span class="op">)</span></span>
<span>  <span class="va">npoints</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="op">!</span><span class="va">data</span><span class="op">$</span><span class="va">Buffer</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>bbox <span class="op">=</span> <span class="va">bbox</span>, npoints <span class="op">=</span> <span class="va">npoints</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">del</span> <span class="op">=</span> <span class="fu"><a href="../reference/triangulate.html">triangulate</a></span><span class="op">(</span>filter <span class="op">=</span> <span class="fu"><a href="../reference/filters.html">keep_ground</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">npts</span> <span class="op">=</span> <span class="fu"><a href="../reference/callback.html">callback</a></span><span class="op">(</span><span class="va">count_buffer_aware</span>, expose <span class="op">=</span> <span class="st">"b"</span><span class="op">)</span> <span class="co"># b for buffer</span></span>
<span><span class="va">sum</span> <span class="op">=</span> <span class="fu"><a href="../reference/summarise.html">summarise</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">ans</span> <span class="op">=</span> <span class="fu"><a href="../reference/exec.html">exec</a></span><span class="op">(</span><span class="va">del</span> <span class="op">+</span> <span class="va">npts</span> <span class="op">+</span> <span class="va">sum</span>, on <span class="op">=</span> <span class="va">f</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">ans</span><span class="op">$</span><span class="va">callback</span><span class="op">)</span></span>
<span><span class="co">#&gt;  - List:</span></span>
<span><span class="co">#&gt;    - bbox : 885022.4 629157.2 885210.2 629400 </span></span>
<span><span class="co">#&gt;    - npoints : 531662 </span></span>
<span><span class="co">#&gt;  - List:</span></span>
<span><span class="co">#&gt;    - bbox : 885024.1 629400 885217.1 629700 </span></span>
<span><span class="co">#&gt;    - npoints : 823945</span></span>
<span><span class="va">ans</span><span class="op">$</span><span class="va">callback</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">npoints</span><span class="op">+</span> <span class="va">ans</span><span class="op">$</span><span class="va">callback</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">npoints</span></span>
<span><span class="co">#&gt; [1] 1355607</span></span>
<span><span class="va">ans</span><span class="op">$</span><span class="va">summary</span><span class="op">$</span><span class="va">npoints</span></span>
<span><span class="co">#&gt; [1] 1355607</span></span></code></pre></div>
<p>In conclusion, in the hypothesis that the user-defined function
returns something complex, there are two ways to handle the buffer:
either using the bounding box or using the <code>Buffer</code> flag. A
third option is to use <code>drop_buffer</code>. In this case users
ensure to receive a <code>data.frame</code> that does not include points
from the buffer.</p>
</div>
<div class="section level2">
<h2 id="parallelisation">Parallelisation<a class="anchor" aria-label="anchor" href="#parallelisation"></a>
</h2>
<blockquote style="background-color: #f8d7da; border-left: 5px solid #dc3545; padding: 10px; font-size: 14px; border-radius: 5px;">
Read the <a href="multithreading.html">multithreading page</a> before
entering this section.
</blockquote>
<p>R is <strong>NOT</strong> multi-threaded, and thus calling these
stages in parallel is not thread-safe and will crash the R session in
the best case or deeply corrupt the R memory in the worst case.
Consequently, these stages are protected and cannot run concurrently
with a <code>concurrent-file</code> strategy. These stages are only
meant to build complex but convenient pipelines and do not intend to be
production tools. While
<code>lasR::rasterize(10, mymetrics(Z, Intensity))</code> produces the
same output as
<code>lidR::pixel_metrics(las, mymetrics(Z, Intensity), 10)</code>, the
<code>lidR</code> version is faster because it can be parallelized on
<strong>multiple R sessions</strong>.</p>
<p><code>lasR</code>, on the other hand, parallelizes the computation in
a <strong>single R session</strong>. This approach has pros and cons
which won’t be discussed in this tutorial. One con is that pipelines
using injected R code are not parallelizable by default.</p>
<!--
When a pipeline has stages that use the R API (in orange in the figure below), the stages that use R are blocking the other stages that are waiting (see figure below).


![](concurent_points_with_R.png){width=600px}

Of course, as depicted in the diagram above, this incurs a computational time cost. If the blocking stages take a lot of time compared to the other stages it could even defeat the interest of the multi-files parallelization. Therefore, users are discouraged from using these stages if alternatives are available. For example, `rasterize()` offers numerous native metrics coded in C++, making custom metrics coded in R unnecessary.

It is worth mentioning that the `lidR` package does not face this problem because each core runs a different and independent R session, thanks to the `future` package. While this approach has the advantage of being non blocking, it also comes with several inconveniences. In contrast, `lasR` utilizes only one R session to process multiple files in parallel. One consequences is that `lasR` will run `rasterize()` with custom metrics or `callback()` in parallel much slower than `lidR`.

With multiple files and complex pipeline, the overhead of blocking the pipeline for stages that use R *might* be less significant because once the pipelines are out of sync, the blocking stages *may* no longer occur simultaneously and thus cease to be blocking, as illustrated in the figure below with 8 files and 4 cores. This happens only if the blocking stages are quick behind the other stages.

![](concurent_points_with_R_8.png)-->
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Jean-Romain Roussel.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
