<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Tutorial â€¢ lasR</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Tutorial">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">lasR</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.17.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Presentation</h6></li>
    <li><a class="dropdown-item" href="../articles/why.html">Why lasR?</a></li>
    <li><a class="dropdown-item" href="../articles/benchmarks.html">Benchmarks of lasR vs. lidR</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Tutorials</h6></li>
    <li><a class="dropdown-item" href="../articles/tutorial.html">Tutorial</a></li>
    <li><a class="dropdown-item" href="../articles/multithreading.html">Parallel processing</a></li>
    <li><a class="dropdown-item" href="../articles/r-stages.html">R stages</a></li>
    <li><a class="dropdown-item" href="../articles/baba.html">Buffered Area Based Approach</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/r-lidar/lasR/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Tutorial</h1>
                        <h4 data-toc-skip class="author">Jean-Romain
Roussel</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/r-lidar/lasR/blob/main/vignettes/tutorial.Rmd" class="external-link"><code>vignettes/tutorial.Rmd</code></a></small>
      <div class="d-none name"><code>tutorial.Rmd</code></div>
    </div>

    
    
<blockquote style="background-color: #ffc5c5; border-left: 5px solid #ff2222; padding: 10px;font-size: 14px; border-radius: 5px;">
This tutorial has been written with the R API (<code>lasR</code>
package) and the codes are thus written in <code>R</code>. It should be
very similar in <code>python</code>. This tutorial is more about the
general concept than about coding.
</blockquote>
<p>This tutorial is intended to be read in order. It introduces the
available tools of the package in a specific order so that the reader
can discover all the features of the package organically.</p>
<blockquote style="background-color: #d6e9f9; border-left: 5px solid #428bca; padding: 10px;font-size: 14px; border-radius: 5px;">
In the following tutorial, the variable <code>f</code> refers to one or
several file paths stored in a vector. It can also be the path to a
directory or the path of a <a href="https://www.lutraconsulting.co.uk/blog/2023/06/08/virtual-point-clouds/" class="external-link">virtual
point cloud</a>. It can also be a point cloud loaded in memory. In this
tutorial, the output is rendered with one or two small LAS files, but
every pipeline is designed to support the processing of numerous files
covering a large extent.
</blockquote>
<div class="section level2">
<h2 id="overall-functionality">Overall functionality<a class="anchor" aria-label="anchor" href="#overall-functionality"></a>
</h2>
<p>In <code>lasR</code>, the R functions provided to the user are not
designed to process the data directly; instead, they are used to create
a pipeline. A pipeline consists of atomic stages that are applied to a
point cloud in order. Each stage can either transform the point cloud
within the pipeline without generating any output or process the point
cloud to produce an output.</p>
<p>In the figure below, there are 4 LAS/LAZ files and a pipeline that
(1) reads a file, (2) builds and writes a DTM on disk, (3) transforms
the point cloud by normalizing the elevation, (4) builds a canopy height
model using the transformed point cloud, and (5) transforms the point
cloud by removing points below 5 m. The resulting version of the point
cloud (points above 5m) is discarded and lost because there is no
additional stage in this pipeline. However, other stages can be added,
such as the application of a predictive model for points above 5 m or a
stage that writes the point cloud to disk.</p>
<p>Once the first file completes the entire pipeline, the second file is
used, and the pipeline is applied to fill in the missing parts of the
geospatial rasters or vectors produced by the pipeline. <strong>Each
file is loaded with a buffer from neighboring files if
needed</strong>.</p>
<p>A pipeline created from the R interface does nothing initially. After
building the pipeline, users must call the <code><a href="../reference/exec.html">exec()</a></code> function
on it to initiate the computation.</p>
<p><img src="pipeline.png"></p>
</div>
<div class="section level2">
<h2 id="reader">Reader<a class="anchor" aria-label="anchor" href="#reader"></a>
</h2>
<p>The <code><a href="../reference/reader.html">reader()</a></code> stage MUST be the first stage of any
pipeline (blue in the figure above). This stage reads the point cloud.
When creating a pipeline with only this stage, the header of the files
are read, but no computation is actually applied. No result is
returned.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pipeline</span> <span class="op">=</span> <span class="fu"><a href="../reference/reader.html">reader</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/exec.html">exec</a></span><span class="op">(</span><span class="va">pipeline</span>, on <span class="op">=</span> <span class="va">f</span><span class="op">)</span></span>
<span><span class="co">#&gt; NULL</span></span></code></pre></div>
<p>In practice when using <code><a href="../reference/reader.html">reader()</a></code> without argument it can
be omitted, the function <code>exec</code> adds it on-the-fly.</p>
</div>
<div class="section level2">
<h2 id="triangulate">Triangulate<a class="anchor" aria-label="anchor" href="#triangulate"></a>
</h2>
<p>The first stage we can try is <code><a href="../reference/triangulate.html">triangulate()</a></code>. This
algorithm performs a Delaunay triangulation on the points of interest.
Triangulating points is a very useful task that is employed in numerous
processing tasks. Triangulating all points is not very interesting, so
we usually want to use the <code>filter</code> argument to triangulate
only specific points of interest.</p>
<p>In the following example, we triangulate the points classified as 2
(i.e., ground). This produces a meshed Digital Terrain Model. The files
are read sequentially, with points loaded one by one and stored to build
a Delaunay triangulation. The program stores the point cloud and the
Delaunay triangulation for the current processing file. Then the data
are discarded to load a new file.</p>
<p>If the users do not provide a path to an output file to store the
result, the result is lost. In the following pipeline, we are building a
triangulation of the ground points, but we get no output because
everything is lost.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pipeline</span> <span class="op">=</span> <span class="fu"><a href="../reference/reader.html">reader</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="../reference/triangulate.html">triangulate</a></span><span class="op">(</span>filter <span class="op">=</span> <span class="st">"Classification == 2"</span><span class="op">)</span></span>
<span><span class="va">ans</span> <span class="op">=</span> <span class="fu"><a href="../reference/exec.html">exec</a></span><span class="op">(</span><span class="va">pipeline</span>, on <span class="op">=</span> <span class="va">f</span><span class="op">)</span></span>
<span><span class="va">ans</span></span>
<span><span class="co">#&gt; NULL</span></span></code></pre></div>
<p>In the following pipeline the triangulation is stored in a geopackage
file by providing an argument <code>ofile</code>:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pipeline</span> <span class="op">=</span> <span class="fu"><a href="../reference/reader.html">reader</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="../reference/triangulate.html">triangulate</a></span><span class="op">(</span>filter <span class="op">=</span> <span class="fu"><a href="../reference/filters.html">keep_ground</a></span><span class="op">(</span><span class="op">)</span>, ofile <span class="op">=</span> <span class="fu"><a href="../reference/temporary_files.html">tempgpkg</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">ans</span> <span class="op">=</span> <span class="fu"><a href="../reference/exec.html">exec</a></span><span class="op">(</span><span class="va">pipeline</span>, on <span class="op">=</span> <span class="va">f</span><span class="op">)</span></span>
<span><span class="va">ans</span></span>
<span><span class="co">#&gt; Simple feature collection with 1 feature and 0 fields</span></span>
<span><span class="co">#&gt; Geometry type: MULTIPOLYGON</span></span>
<span><span class="co">#&gt; Dimension:     XYZ</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: 273357.2 ymin: 5274357 xmax: 273642.9 ymax: 5274643</span></span>
<span><span class="co">#&gt; z_range:       zmin: 788.9932 zmax: 814.8322</span></span>
<span><span class="co">#&gt; Projected CRS: NAD83(CSRS) / MTM zone 7</span></span>
<span><span class="co">#&gt;                             geom</span></span>
<span><span class="co">#&gt; 1 MULTIPOLYGON Z (((273500.4 ...</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">2</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">ans</span>, axes <span class="op">=</span> <span class="cn">T</span>, lwd <span class="op">=</span> <span class="fl">0.5</span>,  cex.axis <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span></code></pre></div>
<p><img src="tutorial_files/figure-html/triangulate2-1.png" width="480"></p>
<p>Notice the use of <code><a href="../reference/filters.html">keep_ground()</a></code> which is a shortcut for
<code>"Classification == 2"</code>. We can also triangulate the first
returns. This produce a meshed Digital Surface Model.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">read</span> <span class="op">=</span> <span class="fu"><a href="../reference/reader.html">reader</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">del</span> <span class="op">=</span> <span class="fu"><a href="../reference/triangulate.html">triangulate</a></span><span class="op">(</span>filter <span class="op">=</span> <span class="fu"><a href="../reference/filters.html">keep_first</a></span><span class="op">(</span><span class="op">)</span>, ofile <span class="op">=</span> <span class="fu"><a href="../reference/temporary_files.html">tempgpkg</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">ans</span> <span class="op">=</span> <span class="fu"><a href="../reference/exec.html">exec</a></span><span class="op">(</span><span class="va">read</span><span class="op">+</span><span class="va">del</span>, on <span class="op">=</span> <span class="va">f</span><span class="op">)</span></span></code></pre></div>
<p>We can also perform both triangulations in the same pipeline.
<strong>The idea of <code>lasR</code> is to execute all the tasks in one
pass using a pipeline:</strong></p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">read</span> <span class="op">=</span> <span class="fu"><a href="../reference/reader.html">reader</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">del1</span> <span class="op">=</span> <span class="fu"><a href="../reference/triangulate.html">triangulate</a></span><span class="op">(</span>filter <span class="op">=</span> <span class="fu"><a href="../reference/filters.html">keep_ground</a></span><span class="op">(</span><span class="op">)</span>, ofile <span class="op">=</span> <span class="fu"><a href="../reference/temporary_files.html">tempgpkg</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">del2</span> <span class="op">=</span> <span class="fu"><a href="../reference/triangulate.html">triangulate</a></span><span class="op">(</span>filter <span class="op">=</span> <span class="fu"><a href="../reference/filters.html">keep_first</a></span><span class="op">(</span><span class="op">)</span>, ofile <span class="op">=</span> <span class="fu"><a href="../reference/temporary_files.html">tempgpkg</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">pipeline</span> <span class="op">=</span> <span class="va">read</span> <span class="op">+</span> <span class="va">del1</span> <span class="op">+</span> <span class="va">del2</span></span>
<span><span class="va">ans</span> <span class="op">=</span> <span class="fu"><a href="../reference/exec.html">exec</a></span><span class="op">(</span><span class="va">pipeline</span>, on <span class="op">=</span> <span class="va">f</span><span class="op">)</span></span></code></pre></div>
<p>Using <code><a href="../reference/triangulate.html">triangulate()</a></code> without any other stage in the
pipeline is usually not very useful. Typically,
<code><a href="../reference/triangulate.html">triangulate()</a></code> is employed without the <code>ofile</code>
argument as an intermediate step. For instance, it can be used with
<code><a href="../reference/rasterize.html">rasterize()</a></code>.</p>
</div>
<div class="section level2">
<h2 id="rasterize">Rasterize<a class="anchor" aria-label="anchor" href="#rasterize"></a>
</h2>
<p><code><a href="../reference/rasterize.html">rasterize()</a></code> does exactly what users may expect from it
and even more. There are three variations:</p>
<ol style="list-style-type: decimal">
<li>Rasterize a Delaunay triangulation.</li>
<li>Rasterize with predefined operators. The operators are optimized
internally, making the operations as fast as possible.</li>
<li>Rasterize by injecting a user-defined R expression. This is
equivalent to <code>pixel_metrics()</code> from the package
<code>lidR</code>. Any user-defined function can be mapped, making it
extremely versatile but slower.</li>
</ol>
<p>With these variations, users can build a CHM, a DTM, a predictive
model, or anything else.</p>
<div class="section level3">
<h3 id="rasterize---triangulation">Rasterize - triangulation<a class="anchor" aria-label="anchor" href="#rasterize---triangulation"></a>
</h3>
<p>Letâ€™s build a DTM using a triangulation of the ground points and the
<code><a href="../reference/rasterize.html">rasterize()</a></code> stage. In the following pipeline, the LAS files
are read, points are loaded for each LAS file <strong>with a
buffer</strong>, a Delaunay triangulation of the ground points is built,
and then the triangulation is interpolated and rasterized. By default,
<code><a href="../reference/rasterize.html">rasterize()</a></code> writes the raster in a temporary file, so the
result is not discarded.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># omitting reader() for the example</span></span>
<span><span class="va">del</span> <span class="op">=</span> <span class="fu"><a href="../reference/triangulate.html">triangulate</a></span><span class="op">(</span>filter <span class="op">=</span> <span class="fu"><a href="../reference/filters.html">keep_ground</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">dtm</span> <span class="op">=</span> <span class="fu"><a href="../reference/rasterize.html">rasterize</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">del</span><span class="op">)</span></span>
<span><span class="va">pipeline</span> <span class="op">=</span> <span class="va">del</span> <span class="op">+</span> <span class="va">dtm</span></span>
<span><span class="va">ans</span> <span class="op">=</span> <span class="fu"><a href="../reference/exec.html">exec</a></span><span class="op">(</span><span class="va">pipeline</span>, on <span class="op">=</span> <span class="va">f</span><span class="op">)</span></span>
<span><span class="va">ans</span></span>
<span><span class="co">#&gt; class       : SpatRaster </span></span>
<span><span class="co">#&gt; size        : 286, 286, 1  (nrow, ncol, nlyr)</span></span>
<span><span class="co">#&gt; resolution  : 1, 1  (x, y)</span></span>
<span><span class="co">#&gt; extent      : 273357, 273643, 5274357, 5274643  (xmin, xmax, ymin, ymax)</span></span>
<span><span class="co">#&gt; coord. ref. : NAD83(CSRS) / MTM zone 7 (EPSG:2949) </span></span>
<span><span class="co">#&gt; source      : file294f5194e1ee.tif </span></span>
<span><span class="co">#&gt; name        : file294f5194e1ee</span></span></code></pre></div>
<p>Here, <code><a href="../reference/exec.html">exec()</a></code> returns only one <code>SpatRaster</code>
because <code><a href="../reference/triangulate.html">triangulate()</a></code> returns nothing (<code>NULL</code>).
Therefore, the pipeline contains two stages, but only one returns
something.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">ans</span>, col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/gray.colors.html" class="external-link">gray.colors</a></span><span class="op">(</span><span class="fl">25</span>,<span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span>, mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="tutorial_files/figure-html/plotdtm-1.png" width="700"></p>
<p>Notice that, contrary to the <code>lidR</code> package, there is
usually no high-level function with names like
<code>rasterize_terrain()</code>. Instead, <code>lasR</code> is made up
of low-level atomic stages that are more versatile but also more
challenging to use.</p>
</div>
<div class="section level3">
<h3 id="rasterize---internal-metrics">Rasterize - internal metrics<a class="anchor" aria-label="anchor" href="#rasterize---internal-metrics"></a>
</h3>
<p>Internal metrics are strings with a format
<code>attribute_function</code>. <code>attribute</code> is an attribute
of the point cloud such as <code>z</code>, <code>classification</code>,
or <code>intensity</code>. <code>function</code> is an available metrics
function such as <code>mean</code>, <code>max</code>, or
<code>sd</code>. The following are examples of valid metric strings:
<code>z_max</code>, <code>i_mean</code>, <code>intensity_mean</code>,
<code>classification_mode</code>, <code>z_sd</code>. Readers can refer
to the official documentation to discover all the possible
combinations.</p>
<p>Letâ€™s build two CHMs: one based on the highest point per pixel with a
resolution of 2 meters, and the second based on the triangulation of the
first returns with a resolution of 50 cm.</p>
<p>In the following pipeline, we are using two variations of
<code><a href="../reference/rasterize.html">rasterize()</a></code>: one capable of rasterizing a triangulation and
the other capable of rasterizing the point cloud with a predefined
operator (here <code>max</code> is interpreted as <code>z_max</code> in
absence of explicit attribute). The output is a named <code>list</code>
with two <code>SpatRaster</code>.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">del</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/triangulate.html">triangulate</a></span><span class="op">(</span>filter <span class="op">=</span> <span class="fu"><a href="../reference/filters.html">keep_first</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">chm1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rasterize.html">rasterize</a></span><span class="op">(</span><span class="fl">2</span>, <span class="st">"max"</span><span class="op">)</span></span>
<span><span class="va">chm2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rasterize.html">rasterize</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="va">del</span><span class="op">)</span></span>
<span><span class="va">pipeline</span> <span class="op">&lt;-</span> <span class="va">del</span> <span class="op">+</span> <span class="va">chm1</span> <span class="op">+</span> <span class="va">chm2</span></span>
<span><span class="va">ans</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/exec.html">exec</a></span><span class="op">(</span><span class="va">pipeline</span>, on <span class="op">=</span> <span class="va">f</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">ans</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">3</span><span class="op">)</span>, col <span class="op">=</span> <span class="va">col</span><span class="op">)</span></span>
<span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">ans</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span>, mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">3</span><span class="op">)</span>, col <span class="op">=</span> <span class="va">col</span><span class="op">)</span></span></code></pre></div>
<p><img src="tutorial_files/figure-html/rasterize2-1.png" width="50%"><img src="tutorial_files/figure-html/rasterize2-2.png" width="50%"></p>
<blockquote style="background-color: #d6e9f9; border-left: 5px solid #428bca; padding: 10px;font-size: 14px; border-radius: 5px;">
For simplicity the package has pre-installed pipelines named
<code><a href="../reference/dsm.html">dsm()</a></code> and <code><a href="../reference/dtm.html">dtm()</a></code> that do what is explained
above.
</blockquote>
</div>
<div class="section level3">
<h3 id="rasterize---r-expression">Rasterize - R expression<a class="anchor" aria-label="anchor" href="#rasterize---r-expression"></a>
</h3>
<p>This special case is covered in a special tutorial about <a href="r-stages.html">R-based stages</a></p>
</div>
<div class="section level3">
<h3 id="rasterize---buffered">Rasterize - buffered<a class="anchor" aria-label="anchor" href="#rasterize---buffered"></a>
</h3>
<p>The <code>lasR</code> package introduced the concept of a buffered
area-based approach to enhance the resolution of prediction maps.
However, this concept is not covered in detail in this tutorial. For
further information, readers can refer to the <a href="baba.html">dedicated article</a></p>
</div>
</div>
<div class="section level2">
<h2 id="transform-with">Transform with<a class="anchor" aria-label="anchor" href="#transform-with"></a>
</h2>
<p>Another way to use a Delaunay triangulation is to transform the point
cloud. Users can add or subtract the triangulation from the point cloud,
effectively normalizing it. Unlike the <code>lidR</code> package, there
is no high-level function with names like
<code>normalize_points()</code>. Instead, <code>lasR</code> is composed
of low-level atomic stages that offer more versatility.</p>
<p>Letâ€™s normalize the point cloud using a triangulation of the ground
points (meshed DTM).</p>
<p>In the following example, the triangulation is used by
<code><a href="../reference/transform_with.html">transform_with()</a></code> that modifies the point cloud in the
pipeline. Both <code><a href="../reference/triangulate.html">triangulate()</a></code> and
<code><a href="../reference/transform_with.html">transform_with()</a></code> return nothing. The output is
<code>NULL</code>.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">del</span> <span class="op">=</span> <span class="fu"><a href="../reference/triangulate.html">triangulate</a></span><span class="op">(</span>filter <span class="op">=</span> <span class="fu"><a href="../reference/filters.html">keep_ground</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">norm</span> <span class="op">=</span> <span class="fu"><a href="../reference/transform_with.html">transform_with</a></span><span class="op">(</span><span class="va">del</span>, <span class="st">"-"</span><span class="op">)</span></span>
<span><span class="va">pipeline</span> <span class="op">=</span> <span class="va">del</span> <span class="op">+</span> <span class="va">norm</span></span>
<span><span class="va">ans</span> <span class="op">=</span> <span class="fu"><a href="../reference/exec.html">exec</a></span><span class="op">(</span><span class="va">pipeline</span>, on <span class="op">=</span> <span class="va">f</span><span class="op">)</span></span>
<span><span class="va">ans</span></span>
<span><span class="co">#&gt; NULL</span></span></code></pre></div>
<blockquote style="background-color: #d6e9f9; border-left: 5px solid #428bca; padding: 10px;font-size: 14px; border-radius: 5px;">
For convenience this pipeline is pre-recorded in the package under the
name <code><a href="../reference/hag.html">normalize()</a></code>.
</blockquote>
<blockquote style="background-color: #d6e9f9; border-left: 5px solid #428bca; padding: 10px;font-size: 14px; border-radius: 5px;">
<code><a href="../reference/transform_with.html">transform_with()</a></code> can also transform with a raster and a
rotation matrix. This is not presented in this tutorial.
</blockquote>
<p>To obtain a meaningful output, it is necessary to chain another
stage. Here the point cloud has been modified but then, it is discarded
because we did nothing with it. For instance, we can compute a Canopy
Height Model (CHM) on the normalized point cloud. In the following
pipeline, the first rasterization (<code>chm1</code>) is applied before
normalization, while the second rasterization occurs after
<code><a href="../reference/transform_with.html">transform_with()</a></code>, thus being applied to the transformed
point cloud.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">del</span> <span class="op">=</span> <span class="fu"><a href="../reference/triangulate.html">triangulate</a></span><span class="op">(</span>filter <span class="op">=</span> <span class="fu"><a href="../reference/filters.html">keep_ground</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">norm</span> <span class="op">=</span> <span class="fu"><a href="../reference/transform_with.html">transform_with</a></span><span class="op">(</span><span class="va">del</span>, <span class="st">"-"</span><span class="op">)</span></span>
<span><span class="va">chm1</span> <span class="op">=</span> <span class="fu"><a href="../reference/rasterize.html">rasterize</a></span><span class="op">(</span><span class="fl">2</span>, <span class="st">"max"</span><span class="op">)</span></span>
<span><span class="va">chm2</span> <span class="op">=</span> <span class="fu"><a href="../reference/rasterize.html">rasterize</a></span><span class="op">(</span><span class="fl">2</span>, <span class="st">"max"</span><span class="op">)</span></span>
<span><span class="va">pipeline</span> <span class="op">=</span> <span class="va">chm1</span> <span class="op">+</span> <span class="va">del</span> <span class="op">+</span> <span class="va">norm</span> <span class="op">+</span> <span class="va">chm2</span></span>
<span><span class="va">ans</span> <span class="op">=</span> <span class="fu"><a href="../reference/exec.html">exec</a></span><span class="op">(</span><span class="va">pipeline</span>, on <span class="op">=</span> <span class="va">f</span><span class="op">)</span></span>
<span></span>
<span><span class="va">col</span> <span class="op">=</span> <span class="fu">grDevices</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/grDevices/colorRamp.html" class="external-link">colorRampPalette</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"blue"</span>, <span class="st">"cyan2"</span>, <span class="st">"yellow"</span>, <span class="st">"red"</span><span class="op">)</span><span class="op">)</span><span class="op">(</span><span class="fl">15</span><span class="op">)</span></span>
<span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">ans</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, <span class="va">ans</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>, col <span class="op">=</span> <span class="va">col</span><span class="op">)</span></span></code></pre></div>
<p><img src="tutorial_files/figure-html/twt2-1.png" width="768"></p>
<p>After performing normalization, users may want to write the
normalized point cloud to disk for later use. In this case, you can
append the <code><a href="../reference/write.html">write_las()</a></code> stage to the pipeline.</p>
</div>
<div class="section level2">
<h2 id="write-las">Write LAS<a class="anchor" aria-label="anchor" href="#write-las"></a>
</h2>
<p><code><a href="../reference/write.html">write_las()</a></code> can be called at any point in the pipeline.
It writes one file per input file, using the name of the input files
with added prefixes and suffixes. In the following pipeline, we read the
files, write only the ground points to files named after the original
files with the suffix <code>_ground</code>, perform a triangulation on
the entire point cloud, followed by normalization. Finally, we write the
normalized point cloud with the suffix <code>_normalized</code>.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">write1</span> <span class="op">=</span> <span class="fu"><a href="../reference/write.html">write_las</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"/*_ground.laz"</span><span class="op">)</span>, filter <span class="op">=</span> <span class="fu"><a href="../reference/filters.html">keep_ground</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">write2</span> <span class="op">=</span> <span class="fu"><a href="../reference/write.html">write_las</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"/*_normalized.laz"</span><span class="op">)</span>, <span class="op">)</span></span>
<span><span class="va">del</span> <span class="op">=</span> <span class="fu"><a href="../reference/triangulate.html">triangulate</a></span><span class="op">(</span>filter <span class="op">=</span> <span class="fu"><a href="../reference/filters.html">keep_ground</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">norm</span> <span class="op">=</span> <span class="fu"><a href="../reference/transform_with.html">transform_with</a></span><span class="op">(</span><span class="va">del</span>, <span class="st">"-"</span><span class="op">)</span></span>
<span><span class="va">pipeline</span> <span class="op">=</span>  <span class="va">write1</span> <span class="op">+</span> <span class="va">del</span> <span class="op">+</span> <span class="va">norm</span> <span class="op">+</span> <span class="va">write2</span></span>
<span><span class="va">ans</span> <span class="op">=</span> <span class="fu"><a href="../reference/exec.html">exec</a></span><span class="op">(</span><span class="va">pipeline</span>, on <span class="op">=</span> <span class="va">f</span><span class="op">)</span></span>
<span><span class="va">ans</span></span>
<span><span class="co">#&gt;  - write_las : /tmp/RtmpzaTMGd/bcts_1_ground.laz /tmp/RtmpzaTMGd/bcts_2_ground.laz </span></span>
<span><span class="co">#&gt;  - write_las.1 : /tmp/RtmpzaTMGd/bcts_1_normalized.laz /tmp/RtmpzaTMGd/bcts_2_normalized.laz</span></span></code></pre></div>
<p>It is crucial to include a wildcard <code>*</code> in the file path;
otherwise, a single large file will be created. This behavior may be
intentional. Letâ€™s consider creating a file merge pipeline. In the
following example, no wildcard <code>*</code> is used for the names of
the LAS/LAZ files. The input files are read, and points are sequentially
written to the single file <code>dataset_merged.laz</code>, naturally
forming a merge pipeline.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ofile</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"/dataset_merged.laz"</span><span class="op">)</span></span>
<span><span class="va">merge</span> <span class="op">=</span> <span class="fu"><a href="../reference/reader.html">reader</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="../reference/write.html">write_las</a></span><span class="op">(</span><span class="va">ofile</span><span class="op">)</span></span>
<span><span class="va">ans</span> <span class="op">=</span> <span class="fu"><a href="../reference/exec.html">exec</a></span><span class="op">(</span><span class="va">merge</span>, on <span class="op">=</span> <span class="va">f</span><span class="op">)</span></span>
<span><span class="va">ans</span></span>
<span><span class="co">#&gt; [1] "/tmp/RtmpzaTMGd/dataset_merged.laz"</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="local-maximum">Local maximum<a class="anchor" aria-label="anchor" href="#local-maximum"></a>
</h2>
<p>This stage works either on the point cloud or a raster. In the
following pipeline the first stage builds a CHM, the second stage finds
the local maxima in the point cloud and the second stages finds the
local maxima in the chm. <code>lm1</code> and <code>lm2</code> are
expected to produce relatively close results but not strictly
identical.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">chm</span> <span class="op">=</span> <span class="fu"><a href="../reference/rasterize.html">rasterize</a></span><span class="op">(</span><span class="fl">1</span>, <span class="st">"max"</span><span class="op">)</span></span>
<span><span class="va">lm1</span> <span class="op">=</span> <span class="fu"><a href="../reference/local_maximum.html">local_maximum</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span></span>
<span><span class="va">lm2</span> <span class="op">=</span> <span class="fu"><a href="../reference/local_maximum.html">local_maximum_raster</a></span><span class="op">(</span><span class="va">chm</span>, <span class="fl">3</span><span class="op">)</span></span>
<span><span class="va">pipeline</span> <span class="op">=</span> <span class="va">chm</span> <span class="op">+</span> <span class="va">lm1</span> <span class="op">+</span> <span class="va">lm2</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="tree-segmentation">Tree Segmentation<a class="anchor" aria-label="anchor" href="#tree-segmentation"></a>
</h2>
<p>This section presents a complex pipeline for tree segmentation using
<code><a href="../reference/local_maximum.html">local_maximum_raster()</a></code> to identify tree tops on a CHM. It
uses <code><a href="../reference/region_growing.html">region_growing()</a></code> to segment the trees using the seeds
produced by <code><a href="../reference/local_maximum.html">local_maximum_raster()</a></code>. The Canopy Height Model
(CHM) is triangulation-based using <code><a href="../reference/triangulate.html">triangulate()</a></code> and
<code><a href="../reference/rasterize.html">rasterize()</a></code> on the first returns. The CHM is post-processed
with <code><a href="../reference/pit_fill.html">pit_fill()</a></code>, an algorithm designed to enhance the CHM
by filling pits and NAs. The reader may have noticed that the seeds are
produced with the same raster than the one used in
<code><a href="../reference/region_growing.html">region_growing()</a></code>. This is checked internally to ensure the
seeds are matching the raster used for segmenting the trees.</p>
<p>In this tutorial, the pipeline is tested on one file to render the
page faster. However, this pipeline can be applied to any number of
files and will produce a continuous output, managing the buffer between
files. Every intermediate output can be exported, and in this tutorial,
we export everything to display all the outputs.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">del</span> <span class="op">=</span> <span class="fu"><a href="../reference/triangulate.html">triangulate</a></span><span class="op">(</span>filter <span class="op">=</span> <span class="fu"><a href="../reference/filters.html">keep_first</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">chm</span> <span class="op">=</span> <span class="fu"><a href="../reference/rasterize.html">rasterize</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="va">del</span><span class="op">)</span></span>
<span><span class="va">chm2</span> <span class="op">=</span> <span class="fu"><a href="../reference/pit_fill.html">pit_fill</a></span><span class="op">(</span><span class="va">chm</span><span class="op">)</span></span>
<span><span class="va">seed</span> <span class="op">=</span> <span class="fu"><a href="../reference/local_maximum.html">local_maximum_raster</a></span><span class="op">(</span><span class="va">chm2</span>, <span class="fl">3</span><span class="op">)</span></span>
<span><span class="va">tree</span> <span class="op">=</span> <span class="fu"><a href="../reference/region_growing.html">region_growing</a></span><span class="op">(</span><span class="va">chm2</span>, <span class="va">seed</span><span class="op">)</span></span>
<span><span class="va">pipeline</span> <span class="op">=</span> <span class="va">del</span> <span class="op">+</span> <span class="va">chm</span> <span class="op">+</span> <span class="va">chm2</span> <span class="op">+</span>  <span class="va">seed</span> <span class="op">+</span> <span class="va">tree</span></span>
<span><span class="va">ans</span> <span class="op">=</span> <span class="fu"><a href="../reference/exec.html">exec</a></span><span class="op">(</span><span class="va">pipeline</span>, on <span class="op">=</span> <span class="va">f</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">col</span> <span class="op">=</span> <span class="fu">grDevices</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/grDevices/colorRamp.html" class="external-link">colorRampPalette</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"blue"</span>, <span class="st">"cyan2"</span>, <span class="st">"yellow"</span>, <span class="st">"red"</span><span class="op">)</span><span class="op">)</span><span class="op">(</span><span class="fl">25</span><span class="op">)</span></span>
<span><span class="va">col2</span> <span class="op">=</span> <span class="fu">grDevices</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/grDevices/colorRamp.html" class="external-link">colorRampPalette</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"purple"</span>, <span class="st">"blue"</span>, <span class="st">"cyan2"</span>, <span class="st">"yellow"</span>, <span class="st">"red"</span>, <span class="st">"green"</span><span class="op">)</span><span class="op">)</span><span class="op">(</span><span class="fl">50</span><span class="op">)</span></span>
<span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">ans</span><span class="op">$</span><span class="va">rasterize</span>, col <span class="op">=</span> <span class="va">col</span>, mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">ans</span><span class="op">$</span><span class="va">pit_fill</span>, col <span class="op">=</span> <span class="va">col</span>, mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">ans</span><span class="op">$</span><span class="va">region_growing</span>, col <span class="op">=</span> <span class="va">col2</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample.int</a></span><span class="op">(</span><span class="fl">50</span>, <span class="fl">277</span>, <span class="cn">TRUE</span><span class="op">)</span><span class="op">]</span>, mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">ans</span><span class="op">$</span><span class="va">local_maximum</span><span class="op">$</span><span class="va">geom</span>, add <span class="op">=</span> <span class="cn">T</span>, pch <span class="op">=</span> <span class="fl">19</span>, cex <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span></code></pre></div>
<p><img src="tutorial_files/figure-html/unnamed-chunk-9-1.png" width="384"><img src="tutorial_files/figure-html/unnamed-chunk-9-2.png" width="384"><img src="tutorial_files/figure-html/unnamed-chunk-9-3.png" width="384"></p>
</div>
<div class="section level2">
<h2 id="buffer">Buffer<a class="anchor" aria-label="anchor" href="#buffer"></a>
</h2>
<p>Point clouds are typically stored in multiple contiguous files. To
avoid edge artifacts, each file must be loaded with extra points coming
from neighboring files. Everything is handled automatically.</p>
</div>
<div class="section level2">
<h2 id="hulls">Hulls<a class="anchor" aria-label="anchor" href="#hulls"></a>
</h2>
<p>A Delaunay triangulation defines a convex polygon, which represents
the convex hull of the points. However, in dense point clouds, removing
triangles with large edges due to the absence of points results in a
more complex structure.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">del</span> <span class="op">=</span> <span class="fu"><a href="../reference/triangulate.html">triangulate</a></span><span class="op">(</span><span class="fl">15</span>, filter <span class="op">=</span> <span class="fu"><a href="../reference/filters.html">keep_ground</a></span><span class="op">(</span><span class="op">)</span>, ofile <span class="op">=</span> <span class="fu"><a href="../reference/temporary_files.html">tempgpkg</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">ans</span> <span class="op">=</span> <span class="fu"><a href="../reference/exec.html">exec</a></span><span class="op">(</span><span class="va">del</span>, on <span class="op">=</span> <span class="va">f</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">2</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">ans</span>, axes <span class="op">=</span> <span class="cn">T</span>, lwd <span class="op">=</span> <span class="fl">0.5</span>, cex.axis <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span></code></pre></div>
<p><img src="tutorial_files/figure-html/hulls-1.png" width="480"></p>
<p>The <code><a href="../reference/hulls.html">hulls()</a></code> algorithm computes the contour of the mesh,
producing a concave hull with holes:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">del</span> <span class="op">=</span> <span class="fu"><a href="../reference/triangulate.html">triangulate</a></span><span class="op">(</span><span class="fl">15</span>, filter <span class="op">=</span> <span class="fu"><a href="../reference/filters.html">keep_ground</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">bound</span> <span class="op">=</span> <span class="fu"><a href="../reference/hulls.html">hulls</a></span><span class="op">(</span><span class="va">del</span><span class="op">)</span></span>
<span><span class="va">ans</span> <span class="op">=</span> <span class="fu"><a href="../reference/exec.html">exec</a></span><span class="op">(</span><span class="va">del</span><span class="op">+</span><span class="va">bound</span>, on <span class="op">=</span> <span class="va">f</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">2</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">ans</span>, axes <span class="op">=</span> <span class="cn">T</span>, lwd <span class="op">=</span> <span class="fl">0.5</span>, col <span class="op">=</span> <span class="st">"gray"</span>, cex.axis <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span></code></pre></div>
<p><img src="tutorial_files/figure-html/hulls2-1.png" width="480"></p>
<p>However <code><a href="../reference/hulls.html">hulls()</a></code> is more likely to be used without a
triangulation. In this case it returns the bounding box of each point
cloud file. And if it is used with <code>triangulate(0)</code> it
returns the convex hull but this is a very inefficient way to get the
convex hull.</p>
</div>
<div class="section level2">
<h2 id="readers">Readers<a class="anchor" aria-label="anchor" href="#readers"></a>
</h2>
<p><code><a href="../reference/reader.html">reader()</a></code> MUST be the first stage of each pipeline even
if it can conveniently be omitted in its simplest form. However there
are several readers hidden behind <code><a href="../reference/reader.html">reader()</a></code>:</p>
<ul>
<li>
<code><a href="../reference/reader.html">reader_coverage()</a></code>: will read of the files and process
the entire point cloud. This is the default behavior of
<code><a href="../reference/reader.html">reader()</a></code>.</li>
<li>
<code><a href="../reference/reader.html">reader_rectangles()</a></code>: will read only some rectangular
regions of interest of the coverage and process then sequentially.</li>
<li>
<code><a href="../reference/reader.html">reader_circles()</a></code>: will read only some circular regions
of interest of the coverage and process then sequentially.</li>
</ul>
<p>The following pipeline triangulates the ground points, normalizes the
point cloud, and computes some metric of interest <strong>for each file
of the entire coverage</strong>. Each file is loaded with a buffer so
that triangulation is performed without edge artifacts. Notice the use
of <code>drop_buffer = TRUE</code> to expose the <code>data.frame</code>
without the buffer used to perform the triangulation and
normalization.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my_metric_fun</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">{</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">Z</span><span class="op">)</span> <span class="op">}</span></span>
<span><span class="va">tri</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/triangulate.html">triangulate</a></span><span class="op">(</span>filter <span class="op">=</span> <span class="fu"><a href="../reference/filters.html">keep_ground</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">trans</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/transform_with.html">transform_with</a></span><span class="op">(</span><span class="va">tri</span><span class="op">)</span></span>
<span><span class="va">norm</span> <span class="op">&lt;-</span> <span class="va">tri</span> <span class="op">+</span> <span class="va">trans</span></span>
<span><span class="va">metric</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/callback.html">callback</a></span><span class="op">(</span><span class="va">my_metric_fun</span>, expose <span class="op">=</span> <span class="st">"z"</span>, drop_buffer <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">pipeline</span> <span class="op">=</span> <span class="va">norm</span> <span class="op">+</span> <span class="va">metric</span></span></code></pre></div>
<p>The following pipeline, on the contrary, works exactly the same but
operates only on circular plots.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pipeline</span> <span class="op">=</span> <span class="fu"><a href="../reference/reader.html">reader_circles</a></span><span class="op">(</span><span class="va">xcenter</span>, <span class="va">ycenter</span>, <span class="fl">11.28</span><span class="op">)</span> <span class="op">+</span> <span class="va">pipeline</span></span></code></pre></div>
<p>These readers allow building a ground inventory pipeline, or a plot
extraction for examples</p>
</div>
<div class="section level2">
<h2 id="summarise">Summarise<a class="anchor" aria-label="anchor" href="#summarise"></a>
</h2>
<p>The <code><a href="../reference/summarise.html">summarise()</a></code> stage computes metrics of interest from
the entire point cloud, i.e., all the points read. In the following
example, we are processing four files. The stage reports the number of
points, number of first returns, histograms, and other metrics.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">read</span> <span class="op">=</span> <span class="fu"><a href="../reference/reader.html">reader</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">summary</span> <span class="op">=</span> <span class="fu"><a href="../reference/summarise.html">summarise</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">pipeline</span> <span class="op">=</span> <span class="va">read</span> <span class="op">+</span> <span class="va">summary</span></span>
<span><span class="va">ans</span> <span class="op">=</span> <span class="fu"><a href="../reference/exec.html">exec</a></span><span class="op">(</span><span class="va">pipeline</span>, on <span class="op">=</span> <span class="va">f</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">ans</span><span class="op">)</span></span>
<span><span class="co">#&gt;  - npoints : 2834350 </span></span>
<span><span class="co">#&gt;  - nsingle : 1233936 </span></span>
<span><span class="co">#&gt;  - nwithheld : 0 </span></span>
<span><span class="co">#&gt;  - nsynthetic : 0 </span></span>
<span><span class="co">#&gt;  - npoints_per_return : 1981696 746460 101739 4455 </span></span>
<span><span class="co">#&gt;  - npoints_per_class : 2684009 150341</span></span></code></pre></div>
<p>Like other stages, the output produced by summarise() depends on its
positioning in the pipeline. Letâ€™s insert a sampling stage (not
described in this tutorial). We can see that it summarizes the point
cloud in its current state in the pipeline.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pipeline</span> <span class="op">=</span> <span class="fu"><a href="../reference/summarise.html">summarise</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="../reference/sampling.html">sampling_voxel</a></span><span class="op">(</span><span class="fl">4</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="../reference/summarise.html">summarise</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">ans</span> <span class="op">=</span> <span class="fu"><a href="../reference/exec.html">exec</a></span><span class="op">(</span><span class="va">pipeline</span>, on <span class="op">=</span> <span class="va">f</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">ans</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;  - npoints : 73403 </span></span>
<span><span class="co">#&gt;  - nsingle : 31294 </span></span>
<span><span class="co">#&gt;  - nwithheld : 0 </span></span>
<span><span class="co">#&gt;  - nsynthetic : 0 </span></span>
<span><span class="co">#&gt;  - npoints_per_return : 53538 15828 3569 451 16 1 </span></span>
<span><span class="co">#&gt;  - npoints_per_class : 61347 8159 3897</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">ans</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;  - npoints : 12745 </span></span>
<span><span class="co">#&gt;  - nsingle : 5042 </span></span>
<span><span class="co">#&gt;  - nwithheld : 0 </span></span>
<span><span class="co">#&gt;  - nsynthetic : 0 </span></span>
<span><span class="co">#&gt;  - npoints_per_return : 9415 2589 655 79 6 1 </span></span>
<span><span class="co">#&gt;  - npoints_per_class : 10862 1510 373</span></span></code></pre></div>
<p><code><a href="../reference/summarise.html">summarise()</a></code> can also compute some metrics. In this case,
the metrics are not computed for the entire point cloud (i.e., all the
points read) but for each chunk read (i.e., each file or each query).
This feature, for example, allows computing metrics for a plot
inventory.</p>
</div>
<div class="section level2">
<h2 id="plot-inventory">Plot inventory<a class="anchor" aria-label="anchor" href="#plot-inventory"></a>
</h2>
<p>This pipeline extracts a plot inventory using a shapefile from a
non-normalized point cloud, normalizes each plot with
<code><a href="../reference/transform_with.html">transform_with()</a></code>, and computes some metrics for each plot
using <code><a href="../reference/summarise.html">summarise()</a></code>. It also writes each normalized and
non-normalized plot in separate files. This means that, in a single
pass, it performs the extraction, normalization, saving, and
computation.</p>
<p>Each circular plot is loaded with a buffer to perform a correct
triangulation, but all stages natively know how to handle a buffer. This
means that <code><a href="../reference/summarise.html">summarise()</a></code> computes the metrics without
including buffer points and <code><a href="../reference/write.html">write_las()</a></code> does not write the
buffer points.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ofiles_plot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"/plot_*.las"</span><span class="op">)</span></span>
<span><span class="va">ofiles_plot_norm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"/plot_*_norm.las"</span><span class="op">)</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span>
<span><span class="va">inventory</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html" class="external-link">st_read</a></span><span class="op">(</span><span class="st">"shapefile.shp"</span><span class="op">)</span></span>
<span><span class="va">coordinates</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_coordinates.html" class="external-link">st_coordinates</a></span><span class="op">(</span><span class="va">inventory</span><span class="op">)</span></span>
<span><span class="va">xcenter</span> <span class="op">&lt;-</span> <span class="va">coordinates</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span></span>
<span><span class="va">ycenter</span> <span class="op">&lt;-</span> <span class="va">coordinates</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span></span>
<span></span>
<span><span class="va">read</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/reader.html">reader</a></span><span class="op">(</span>xc <span class="op">=</span> <span class="va">xcenter</span>, yc <span class="op">=</span> <span class="va">ycenter</span>, r <span class="op">=</span> <span class="fl">11.28</span><span class="op">)</span> </span>
<span><span class="va">tri</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/triangulate.html">triangulate</a></span><span class="op">(</span>filter <span class="op">=</span> <span class="fu"><a href="../reference/filters.html">keep_ground</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">trans</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/transform_with.html">transform_with</a></span><span class="op">(</span><span class="va">tri</span><span class="op">)</span></span>
<span><span class="va">norm</span> <span class="op">&lt;-</span> <span class="va">tri</span> <span class="op">+</span> <span class="va">trans</span></span>
<span><span class="va">metrics</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/summarise.html">summarise</a></span><span class="op">(</span>metrics <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"z_mean"</span>, <span class="st">"z_p95"</span>, <span class="st">"i_median"</span>, <span class="st">"count"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">write1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/write.html">write_las</a></span><span class="op">(</span><span class="va">ofiles_plot</span><span class="op">)</span></span>
<span><span class="va">write2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/write.html">write_las</a></span><span class="op">(</span><span class="va">ofiles_plot_norm</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pipeline</span> <span class="op">=</span> <span class="va">read</span> <span class="op">+</span> <span class="va">write1</span> <span class="op">+</span> <span class="va">norm</span> <span class="op">+</span> <span class="va">write2</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="wildcard-usage">Wildcard Usage<a class="anchor" aria-label="anchor" href="#wildcard-usage"></a>
</h2>
<p>Usually, <code><a href="../reference/write.html">write_las()</a></code> is used with a wildcard in the
<code>ofile</code> argument (see above) to write one file per processed
file. Otherwise, everything is written into a single massive LAS file
(which might be the desired behavior). On the contrary,
<code><a href="../reference/rasterize.html">rasterize()</a></code> is used without a wildcard to write everything
into a single raster file, but it also accepts a wildcard to write the
results in multiple files, which is very useful with
<code><a href="../reference/reader.html">reader_circles()</a></code> to avoid having one massive raster mostly
empty. Compare this pipeline with and without the wildcard.</p>
<p>Without a wildcard, the output is a single raster that covers the
entire point cloud with two patches of populated pixels.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ofile</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"/chm.tif"</span><span class="op">)</span>   <span class="co"># no wildcard</span></span>
<span></span>
<span><span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">885100</span>, <span class="fl">885100</span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">629200</span>, <span class="fl">629600</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pipeline</span> <span class="op">=</span> <span class="fu"><a href="../reference/reader.html">reader</a></span><span class="op">(</span>xc <span class="op">=</span> <span class="va">x</span>, yc <span class="op">=</span> <span class="va">y</span>, r <span class="op">=</span> <span class="fl">20</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="../reference/rasterize.html">rasterize</a></span><span class="op">(</span><span class="fl">2</span>, <span class="st">"max"</span>, ofile <span class="op">=</span> <span class="va">ofile</span><span class="op">)</span></span>
<span><span class="va">r0</span> <span class="op">=</span> <span class="fu"><a href="../reference/exec.html">exec</a></span><span class="op">(</span><span class="va">pipeline</span>, on <span class="op">=</span> <span class="va">f</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">r0</span>, col <span class="op">=</span> <span class="va">col</span><span class="op">)</span> <span class="co"># covers the entire collection of files</span></span></code></pre></div>
<p><img src="tutorial_files/figure-html/nowildcard-1.png" width="768"></p>
<p>With a wildcard, the output contains two rasters that cover regions
of interest.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ofile</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"/chm_*.tif"</span><span class="op">)</span> <span class="co"># wildcard</span></span>
<span></span>
<span><span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">885100</span>, <span class="fl">885100</span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">629200</span>, <span class="fl">629600</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pipeline</span> <span class="op">=</span> <span class="fu"><a href="../reference/reader.html">reader</a></span><span class="op">(</span>xc <span class="op">=</span> <span class="va">x</span>, yc <span class="op">=</span> <span class="va">y</span>, r <span class="op">=</span> <span class="fl">20</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="../reference/rasterize.html">rasterize</a></span><span class="op">(</span><span class="fl">2</span>, <span class="st">"max"</span>, ofile <span class="op">=</span> <span class="va">ofile</span><span class="op">)</span></span>
<span><span class="va">ans</span> <span class="op">=</span> <span class="fu"><a href="../reference/exec.html">exec</a></span><span class="op">(</span><span class="va">pipeline</span>, on <span class="op">=</span> <span class="va">f</span><span class="op">)</span></span>
<span></span>
<span><span class="va">r1</span> <span class="op">=</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="va">ans</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">r2</span> <span class="op">=</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="va">ans</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">r1</span>, col <span class="op">=</span> <span class="va">col</span><span class="op">)</span></span>
<span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">r2</span>, col <span class="op">=</span> <span class="va">col</span><span class="op">)</span></span></code></pre></div>
<p><img src="tutorial_files/figure-html/wildcard-1.png" width="50%"><img src="tutorial_files/figure-html/wildcard-2.png" width="50%"></p>
</div>
<div class="section level2">
<h2 id="compatibility-with-lidr">Compatibility with lidR<a class="anchor" aria-label="anchor" href="#compatibility-with-lidr"></a>
</h2>
<p>While <code>lasR</code> does not depends on <code>lidR</code> it has
some compatibility with it. Instead of providing paths to files or
folder it is possible to pass a <code>LAScatalog</code> or a
<code>LAS</code> object to the readers.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/r-lidar/lasR" class="external-link">lasR</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/r-lidar/lidR" class="external-link">lidR</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">pipeline</span> <span class="op">=</span> <span class="fu"><a href="../reference/hag.html">normalize</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="../reference/write.html">write_las</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ctg</span> <span class="op">=</span> <span class="fu">readLAScatalog</span><span class="op">(</span><span class="va">folder</span><span class="op">)</span></span>
<span><span class="va">ans</span> <span class="op">=</span> <span class="fu"><a href="../reference/exec.html">exec</a></span><span class="op">(</span><span class="va">pipeline</span>, on <span class="op">=</span> <span class="va">ctg</span><span class="op">)</span></span>
<span></span>
<span><span class="va">las</span> <span class="op">=</span> <span class="fu">readLAS</span><span class="op">(</span><span class="va">file</span><span class="op">)</span></span>
<span><span class="va">ans</span> <span class="op">=</span> <span class="fu"><a href="../reference/exec.html">exec</a></span><span class="op">(</span><span class="va">pipeline</span>, on <span class="op">=</span> <span class="va">las</span><span class="op">)</span></span></code></pre></div>
<p>In the case of a <code>LAScatalog</code>, <code><a href="../reference/exec.html">exec()</a></code>
respects the processing options of the <code>LAScatalog</code> including
the chunk size, chunk buffer, progress bar display and partial
processing. In the general case, the same options can be supplied as
arguments of the <code><a href="../reference/exec.html">exec()</a></code> functions.</p>
</div>
<div class="section level2">
<h2 id="stop-pipeline-if">Stop pipeline if<a class="anchor" aria-label="anchor" href="#stop-pipeline-if"></a>
</h2>
<p>A pipeline can be a long succession of stages, and it may happen that
we do not want to apply the entire pipeline on every file. In this case,
the <code>stop_if</code> stage allows us to conditionally stop the
pipeline anywhere. Letâ€™s assume we have a dataset with 100 files and a
pipeline that reads, computes the hulls, and computes the DTM.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">read</span> <span class="op">=</span> <span class="fu"><a href="../reference/reader.html">reader</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">hll</span> <span class="op">=</span> <span class="fu"><a href="../reference/hulls.html">hulls</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">tri</span> <span class="op">=</span> <span class="fu"><a href="../reference/triangulate.html">triangulate</a></span><span class="op">(</span>filter <span class="op">=</span> <span class="fu"><a href="../reference/filters.html">keep_ground</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">dtm</span> <span class="op">=</span> <span class="fu"><a href="../reference/rasterize.html">rasterize</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">tri</span><span class="op">)</span></span>
<span><span class="va">pipeline</span> <span class="op">=</span> <span class="va">read</span> <span class="op">+</span> <span class="va">hll</span> <span class="op">+</span> <span class="va">tri</span> <span class="op">+</span> <span class="va">dtm</span></span></code></pre></div>
<p>It is possible to compute the hulls on the 100 files but the DTM only
in a reduced region of interest defined by the user with
<code><a href="../reference/stop_if_outside.html">stop_if_outside()</a></code>.</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">stopif</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stop_if_outside.html">stop_if_outside</a></span><span class="op">(</span><span class="fl">880000</span>, <span class="fl">620000</span>, <span class="fl">885000</span>, <span class="fl">630000</span><span class="op">)</span></span>
<span><span class="va">pipeline</span> <span class="op">&lt;-</span> <span class="va">read</span> <span class="op">+</span> <span class="va">hll</span> <span class="op">+</span> <span class="va">stopif</span> <span class="op">+</span> <span class="va">tri</span> <span class="op">+</span> <span class="va">dtm</span></span></code></pre></div>
<p><code>stop_if</code> is (currently) the only stage that can be put
before <code><a href="../reference/reader.html">reader()</a></code>. In this case, the reading stage is
skipped, effectively applying the pipeline to a subset of the files that
encompass the bounding boxes defined by the user.</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pipeline</span> <span class="op">&lt;-</span> <span class="va">stopif</span> <span class="op">+</span> <span class="va">read</span> <span class="op">+</span> <span class="va">hll</span> <span class="op">+</span> <span class="va">tri</span> <span class="op">+</span> <span class="va">dtm</span></span></code></pre></div>
<p>Notice that the pipeline below produces the same output as the
pipeline above but takes longer to compute because the files that are
not processed are read anyway. It is thus preferable to put
<code>stop_if()</code> before <code><a href="../reference/reader.html">reader()</a></code> in this specific
case.</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pipeline</span> <span class="op">&lt;-</span> <span class="va">read</span> <span class="op">+</span> <span class="va">stopif</span> <span class="op">+</span> <span class="va">hll</span> <span class="op">+</span> <span class="va">tri</span> <span class="op">+</span> <span class="va">dtm</span></span></code></pre></div>
<p>Currently, there is only one <code>stop_if</code> stage that
conditionally stops the pipeline based on a bounding box condition, but
it will be easy to add more options later on demand.</p>
</div>
<div class="section level2">
<h2 id="parallel-processing">Parallel processing<a class="anchor" aria-label="anchor" href="#parallel-processing"></a>
</h2>
<p>The topic is covered in a <a href="multithreading.html">dedicated
article</a></p>
</div>
<div class="section level2">
<h2 id="pre-read-a-point-cloud-in-memory">Pre-read a point cloud in memory<a class="anchor" aria-label="anchor" href="#pre-read-a-point-cloud-in-memory"></a>
</h2>
<p>In this tutorial we have seen the batch processing mode. It is also
possible to load a point cloud in memory with
<code><a href="../reference/read_cloud.html">read_cloud()</a></code></p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">f</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"Topography.las"</span>, package<span class="op">=</span><span class="st">"lasR"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">cloud</span> <span class="op">=</span> <span class="fu"><a href="../reference/read_cloud.html">read_cloud</a></span><span class="op">(</span><span class="va">f</span><span class="op">)</span></span>
<span><span class="va">cloud</span></span>
<span><span class="co">#&gt; Source       : LASF (v1.2)</span></span>
<span><span class="co">#&gt; Size         : 2.28 MB</span></span>
<span><span class="co">#&gt; Extent       : 273357.14 273642.86 5274357.14 5274642.85 (xmin, xmax, ymin, ymax)</span></span>
<span><span class="co">#&gt; Points       : 73.40 thousands</span></span>
<span><span class="co">#&gt; Area         : 81629.0 mÂ²</span></span>
<span><span class="co">#&gt; Density      : 0.9 pts/mÂ²</span></span>
<span><span class="co">#&gt; Coord. ref.  : (null)</span></span>
<span><span class="co">#&gt; Schema       :</span></span>
<span><span class="co">#&gt; 17 attributes | 31 bytes per points</span></span>
<span><span class="co">#&gt;  Name: flags             | uchar  | Desc: Internal 8-bit mask reserved for lasR core engine</span></span>
<span><span class="co">#&gt;  Name: X                 | int    | Desc: X coordinate</span></span>
<span><span class="co">#&gt;  Name: Y                 | int    | Desc: Y coordinate</span></span>
<span><span class="co">#&gt;  Name: Z                 | int    | Desc: Z coordinate</span></span>
<span><span class="co">#&gt;  Name: Intensity         | ushort | Desc: Pulse return magnitude</span></span>
<span><span class="co">#&gt;  Name: ReturnNumber      | uchar  | Desc: Pulse return number for a given output pulse</span></span>
<span><span class="co">#&gt;  Name: NumberOfReturns   | uchar  | Desc: Total number of returns for a given pulse</span></span>
<span><span class="co">#&gt;  Name: Classification    | uchar  | Desc: The 'class' attributes of a point</span></span>
<span><span class="co">#&gt;  Name: UserData          | uchar  | Desc: Used at the userâ€™s discretion</span></span>
<span><span class="co">#&gt;  Name: PointSourceID     | short  | Desc: Source from which this point originated</span></span>
<span><span class="co">#&gt;  Name: ScanAngle         | char   | Desc: Rounded angle at which the laser point was output</span></span>
<span><span class="co">#&gt;  Name: gpstime           | double | Desc: Time tag value at which the point was observed</span></span>
<span><span class="co">#&gt;  Name: EdgeOfFlightline  | bit    | Desc: Set when the point is at the end of a scan</span></span>
<span><span class="co">#&gt;  Name: ScanDirectionFlag | bit    | Desc: Direction in which the scanner mirror was traveling </span></span>
<span><span class="co">#&gt;  Name: Synthetic         | bit    | Desc: Point created by a technique other than direct observation</span></span>
<span><span class="co">#&gt;  Name: Keypoint          | bit    | Desc: Point is considered to be a model key-point</span></span>
<span><span class="co">#&gt;  Name: Withheld          | bit    | Desc: Point is supposed to be deleted)</span></span></code></pre></div>
<p>Once a point cloud is loaded in memory is possible to apply a
pipeline on it. In the following the we are computing a DTM and sampling
the point cloud. The output is thus a raster and the point cloud has
been modified. See above the point cloud was 73,400 point. After
applying the pipeline the object only has 23,780 points</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pipeline</span> <span class="op">=</span> <span class="fu"><a href="../reference/dtm.html">dtm</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="../reference/sampling.html">sampling_poisson</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">ans</span> <span class="op">=</span> <span class="fu"><a href="../reference/exec.html">exec</a></span><span class="op">(</span><span class="va">pipeline</span>, on <span class="op">=</span> <span class="va">cloud</span><span class="op">)</span></span>
<span><span class="va">ans</span></span>
<span><span class="co">#&gt; class       : SpatRaster </span></span>
<span><span class="co">#&gt; size        : 286, 286, 1  (nrow, ncol, nlyr)</span></span>
<span><span class="co">#&gt; resolution  : 1, 1  (x, y)</span></span>
<span><span class="co">#&gt; extent      : 273357, 273643, 5274357, 5274643  (xmin, xmax, ymin, ymax)</span></span>
<span><span class="co">#&gt; coord. ref. :  </span></span>
<span><span class="co">#&gt; source      : file294f790363d.tif </span></span>
<span><span class="co">#&gt; name        : file294f790363d</span></span>
<span><span class="va">cloud</span></span>
<span><span class="co">#&gt; Source       : LASF (v1.2)</span></span>
<span><span class="co">#&gt; Size         : 737.18 kB</span></span>
<span><span class="co">#&gt; Extent       : 273357.14 273642.84 5274357.15 5274642.85 (xmin, xmax, ymin, ymax)</span></span>
<span><span class="co">#&gt; Points       : 23.78 thousands</span></span>
<span><span class="co">#&gt; Area         : 81623.7 mÂ²</span></span>
<span><span class="co">#&gt; Density      : 0.3 pts/mÂ²</span></span>
<span><span class="co">#&gt; Coord. ref.  : (null)</span></span>
<span><span class="co">#&gt; Schema       :</span></span>
<span><span class="co">#&gt; 17 attributes | 31 bytes per points</span></span>
<span><span class="co">#&gt;  Name: flags             | uchar  | Desc: Internal 8-bit mask reserved for lasR core engine</span></span>
<span><span class="co">#&gt;  Name: X                 | int    | Desc: X coordinate</span></span>
<span><span class="co">#&gt;  Name: Y                 | int    | Desc: Y coordinate</span></span>
<span><span class="co">#&gt;  Name: Z                 | int    | Desc: Z coordinate</span></span>
<span><span class="co">#&gt;  Name: Intensity         | ushort | Desc: Pulse return magnitude</span></span>
<span><span class="co">#&gt;  Name: ReturnNumber      | uchar  | Desc: Pulse return number for a given output pulse</span></span>
<span><span class="co">#&gt;  Name: NumberOfReturns   | uchar  | Desc: Total number of returns for a given pulse</span></span>
<span><span class="co">#&gt;  Name: Classification    | uchar  | Desc: The 'class' attributes of a point</span></span>
<span><span class="co">#&gt;  Name: UserData          | uchar  | Desc: Used at the userâ€™s discretion</span></span>
<span><span class="co">#&gt;  Name: PointSourceID     | short  | Desc: Source from which this point originated</span></span>
<span><span class="co">#&gt;  Name: ScanAngle         | char   | Desc: Rounded angle at which the laser point was output</span></span>
<span><span class="co">#&gt;  Name: gpstime           | double | Desc: Time tag value at which the point was observed</span></span>
<span><span class="co">#&gt;  Name: EdgeOfFlightline  | bit    | Desc: Set when the point is at the end of a scan</span></span>
<span><span class="co">#&gt;  Name: ScanDirectionFlag | bit    | Desc: Direction in which the scanner mirror was traveling </span></span>
<span><span class="co">#&gt;  Name: Synthetic         | bit    | Desc: Point created by a technique other than direct observation</span></span>
<span><span class="co">#&gt;  Name: Keypoint          | bit    | Desc: Point is considered to be a model key-point</span></span>
<span><span class="co">#&gt;  Name: Withheld          | bit    | Desc: Point is supposed to be deleted)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="other-stages">Other stages<a class="anchor" aria-label="anchor" href="#other-stages"></a>
</h2>
<p><code>lasR</code> has several other stages not mentioned in this
tutorial. Among others:</p>
<ul>
<li><code><a href="../reference/add_attribute.html">add_extrabytes()</a></code></li>
<li><code><a href="../reference/add_rgb.html">add_rgb()</a></code></li>
<li><code><a href="../reference/callback.html">callback()</a></code></li>
<li><code><a href="../reference/classify_with_ivf.html">classify_with_ivf()</a></code></li>
<li><code><a href="../reference/classify_with_csf.html">classify_with_csf()</a></code></li>
<li><code><a href="../reference/delete_points.html">delete_points()</a></code></li>
<li><code><a href="../reference/geometry_features.html">geometry_features()</a></code></li>
<li><code><a href="../reference/load_raster.html">load_raster()</a></code></li>
<li><code><a href="../reference/pit_fill.html">pit_fill()</a></code></li>
<li><code><a href="../reference/write_vpc.html">write_vpc()</a></code></li>
</ul>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Jean-Romain Roussel.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
